<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Venus Workshop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root { 
        --bg-app: #F2F2F7;
        --bg-panel: linear-gradient(180deg, #FFFFFF 0%, #F5F7FA 100%);      
        --text-main: #1C1C1E;     
        --text-sub: #8E8E93;      
        --accent: #007AFF;        
        --border: rgba(0,0,0,0.08); 
        --border-strong: #C7C7CC;
        --input-bg: #FFFFFF;      
        
        --color-inc: #34C759;
        --color-exp: #FF3B30;     
        --color-prof: #5856D6;    
        --color-vis: #AF52DE;
        
        --danger: #FF3B30;
        --shadow-card: 0 4px 12px rgba(0,0,0,0.06);
        --radius: 20px;
        --scroll-thumb: #C7C7CC;
      }
      
      [data-theme="dark"] { 
        --bg-app: #0f172a;
        --bg-panel: #1e293b; 
        --text-main: #f8fafc;     
        --text-sub: #94a3b8;      
        --accent: #60a5fa;        
        --border: #334155;        
        --border-strong: #475569;
        --input-bg: #0f172a;      
        
        --shadow-card: 0 4px 20px rgba(0,0,0,0.4);
        --color-inc: #4ade80;     
        --color-exp: #f87171;     
        --color-prof: #818cf8;    
        --color-vis: #c084fc;     
        --scroll-thumb: #475569;
      }
      
      /* --- –ì–õ–û–ë–ê–õ–¨–ù–´–ï –°–¢–ò–õ–ò --- */
      body { 
          margin: 0;
          padding: 20px;
          /* –û–ë–©–ò–ô –°–ö–†–û–õ–õ: –†–∞–∑—Ä–µ—à–∞–µ–º —Å—Ç—Ä–∞–Ω–∏—Ü–µ —Ä–∞—Å—Ç–∏ –≤ –≤—ã—Å–æ—Ç—É */
          min-height: 100vh;
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
          background-color: var(--bg-app); 
          color: var(--text-main); 
          box-sizing: border-box; 
          /* –°–∫—Ä–æ–ª–ª –æ—Å—É—â–µ—Å—Ç–≤–ª—è–µ—Ç—Å—è –±—Ä–∞—É–∑–µ—Ä–æ–º, –∞ –Ω–µ –≤–Ω—É—Ç—Ä–µ–Ω–Ω–∏–º–∏ –±–ª–æ–∫–∞–º–∏ */
          overflow-y: auto; 
          -webkit-overflow-scrolling: touch;
          display: flex; 
          flex-direction: column;
          transition: background 0.3s; 
          -webkit-font-smoothing: antialiased;
          font-weight: 500;
          padding-bottom: 50px; /* –û—Ç—Å—Ç—É–ø —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø—Ä–∏–ª–∏–ø–∞–ª –∫ –Ω–∏–∑—É */
      }
      
      /* –≠–∫—Ä–∞–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ */
      #accessDenied {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%;
          background: var(--bg-app); z-index: 9999;
          display: flex; flex-direction: column; align-items: center; justify-content: center;
          text-align: center; padding: 30px; box-sizing: border-box;
      }
      
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
      .brand-box { display: flex; align-items: center; gap: 12px; }
      .title { margin: 0; font-size: 24px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
      
      .venus-icon { width: 42px; height: 42px; cursor: pointer; transition: transform 0.5s ease; }
      .venus-icon:hover { transform: rotate(120deg) scale(1.1); }
      .venus-icon.spinning { animation: spinInfinite 1.5s linear infinite; }
      @keyframes spinInfinite { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      .theme-toggle-btn {
          width: 44px; height: 44px; border-radius: 50%; background: var(--bg-panel); 
          cursor: pointer; display: flex; align-items: center; justify-content: center; overflow: hidden;
          box-shadow: var(--shadow-card); position: relative; border: 1px solid var(--border);
      }
      .theme-icon { position: absolute; font-size: 22px; transition: 0.5s cubic-bezier(0.68,-0.55,0.27,1.55); user-select: none; }
      [data-theme="light"] .icon-sun { transform: rotate(0) scale(1); opacity:1; }
      [data-theme="light"] .icon-moon { transform: rotate(90deg) scale(0); opacity:0; }
      [data-theme="dark"] .icon-sun { transform: rotate(-90deg) scale(0); opacity:0; }
      [data-theme="dark"] .icon-moon { transform: rotate(0) scale(1); opacity:1; }

      /* –ú–ï–ù–Æ (–ù–ê–í–ò–ì–ê–¶–ò–Ø) */
      .nav { 
          display: flex; 
          background: var(--bg-panel); 
          padding: 4px; 
          border-radius: 14px; 
          margin-bottom: 20px; 
          box-shadow: var(--shadow-card); 
          border: 1px solid var(--border); 
          z-index: 100;
      }
      .nav-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-sub); border-radius: 10px; cursor: pointer; font-weight: 600; text-align: center; transition: 0.2s; font-size: 14px; }
      .nav-btn:hover { color: var(--text-main); }
      .nav-btn.active { background: var(--bg-app); color: var(--text-main); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
      [data-theme="dark"] .nav-btn.active { background: #334155; box-shadow: none; }

      .content-area { flex: 1; position: relative; display: flex; flex-direction: column; }
      .tab-page { display: none; width: 100%; }
      .tab-page.active { display: block; animation: fadeIn 0.4s cubic-bezier(0.16, 1, 0.3, 1); }
      
      .split-view { display: flex; gap: 20px; flex-wrap: wrap; }
      .panel { background: var(--bg-panel); border-radius: var(--radius); box-shadow: var(--shadow-card); display: flex; flex-direction: column; border: 1px solid var(--border); }
      
      .panel-left { width: 360px; padding: 30px; box-sizing: border-box; }
      .panel-right { flex: 1; min-width: 300px; padding-bottom: 20px; } /* –†–∞—Å—Ç—è–≥–∏–≤–∞–µ—Ç—Å—è */

      h3 { margin-top: 0; font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 20px; }
      label { font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 8px; display: block; letter-spacing: 0.02em; }
      
      input[type=number]::-webkit-inner-spin-button, input[type=number]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
      input[type=number] { -moz-appearance: textfield; }

      input, select { 
          width: 100%; padding: 14px; 
          border-radius: 12px; border: 1px solid var(--border-strong); 
          background-color: var(--input-bg); color: var(--text-main); 
          font-size: 15px; box-sizing: border-box; outline:none; transition:0.2s; 
          font-weight: 600; font-family: 'Inter', sans-serif;
      }
      
      select {
          appearance: none;
          background-image: url("data:image/svg+xml;charset=US-ASCII,%3Csvg%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20width%3D%22292.4%22%20height%3D%22292.4%22%3E%3Cpath%20fill%3D%22%238E8E93%22%20d%3D%22M287%2069.4a17.6%2017.6%200%200%200-13-5.4H18.4c-5%200-9.3%201.8-12.9%205.4A17.6%2017.6%200%200%200%200%2082.2c0%205%201.8%209.3%205.4%2012.9l128%20127.9c3.6%203.6%207.8%205.4%2012.8%205.4s9.2-1.8%2012.8-5.4L287%2095c3.5-3.5%205.4-7.8%205.4-12.8%200-5-1.9-9.2-5.5-12.8z%22%2F%3E%3C%2Fsvg%3E");
          background-repeat: no-repeat;
          background-position: right 15px top 50%;
          background-size: 10px auto;
          cursor: pointer;
      }
      
      input:focus, select:focus { border-color: var(--accent); background: var(--bg-panel); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
      
      .qty-wrapper { display: flex; align-items: center; background: var(--input-bg); border: 1px solid var(--border-strong); border-radius: 12px; overflow: hidden; padding: 2px; }
      .qty-btn { width: 44px; height: 44px; background: transparent; border: none; color: var(--text-main); font-size: 20px; cursor: pointer; border-radius: 10px; transition: 0.2s; font-weight: 600; }
      .qty-btn:hover { background: rgba(0,0,0,0.05); }
      .qty-input { text-align: center; border: none; font-weight: 700; font-size: 18px; flex: 1; padding: 0; background: transparent; color: var(--text-main); -moz-appearance: textfield; }
      .qty-input:focus { box-shadow: none; border: none; }

      .btn { width: 100%; padding: 18px; background: var(--accent); color: white; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; margin-top: 20px; font-size: 16px; transition: 0.2s; }
      .btn:active { transform: scale(0.98); opacity: 0.9; }
      
      .table-header { padding: 20px 30px; display: flex; justify-content: space-between; align-items: center; border-bottom: 1px solid var(--border); }
      .btn-refresh { padding: 8px 16px; background-color: transparent; border: 1px solid var(--border-strong); border-radius: 8px; font-weight: 600; cursor: pointer; color: var(--text-main); font-size: 12px; transition: 0.2s; }
      .btn-refresh:hover { background-color: var(--input-bg); border-color: var(--accent); color: var(--accent); }

      /* –£–ë–ò–†–ê–ï–ú –í–ù–£–¢–†–ï–ù–ù–ò–ô –°–ö–†–û–õ–õ, –¢–ï–ü–ï–†–¨ –¢–ê–ë–õ–ò–¶–ê –†–ê–°–¢–Ø–ì–ò–í–ê–ï–¢–°–Ø */
      .grid-wrapper { padding: 0 10px; overflow: visible; }
      
      table { width: 100%; border-collapse: separate; border-spacing: 0 8px; }
      /* –õ–∏–ø–∫–∏–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ –æ–∫–Ω–∞ –±—Ä–∞—É–∑–µ—Ä–∞ */
      th { position: sticky; top: 0; background: var(--bg-panel); color: var(--text-sub); font-size: 11px; text-transform: uppercase; text-align: left; padding: 10px 20px; font-weight: 700; z-index: 10; box-shadow: 0 1px 0 var(--border); }
      
      td { padding: 16px 20px; background: var(--input-bg); border: 1px solid var(--border); font-size: 14px; color: var(--text-main); vertical-align: middle; font-weight: 500; }
      tr td:first-child { border-top-left-radius: 14px; border-bottom-left-radius: 14px; border-right: none; }
      tr td:last-child { border-top-right-radius: 14px; border-bottom-right-radius: 14px; text-align: right; border-left: none; }
      tr td:not(:first-child):not(:last-child) { border-left: none; border-right: none; }
      
      th:nth-child(1) { width: 90px; } 
      th:nth-child(2) { width: auto; }   
      th:nth-child(3) { width: 100px; text-align: right; } 
      th:nth-child(4) { width: 220px; text-align: right; }

      .btn-table { padding: 6px 14px; border-radius: 8px; font-size: 12px; font-weight: 600; cursor: pointer; border: 1px solid var(--border-strong); background: transparent; color: var(--text-sub); margin-left: 6px; display: inline-block; transition: 0.2s; }
      .btn-edit:hover { border-color: var(--accent); background-color: var(--accent); color: white; }
      .btn-del:hover { border-color: var(--danger); background-color: var(--danger); color: white; }

      .analytics-container { padding: 0 10px 20px 10px; width: 100%; box-sizing: border-box; }
      .filters-row { display: flex; gap: 15px; margin-bottom: 25px; }
      .filters-row select { flex: 1; width: 50%; padding: 14px; cursor: pointer; }
      
      .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px; margin-bottom: 30px; }
      .kpi-card { background: var(--bg-panel); padding: 25px; border-radius: 24px; box-shadow: var(--shadow-card); position: relative; border: 1px solid var(--border); }
      .kpi-title { font-size: 12px; color: var(--text-sub); text-transform: uppercase; font-weight: 700; margin-bottom: 8px; letter-spacing: 0.5px; }
      .kpi-val { font-size: 32px; font-weight: 800; color: var(--text-main); letter-spacing: -1px; }
      .kpi-trend { font-size: 13px; font-weight: 700; margin-top: 5px; display: inline-block; padding: 4px 10px; border-radius: 20px; }
      .trend-up { background: rgba(52, 199, 89, 0.15); color: var(--color-inc); }
      .trend-down { background: rgba(255, 59, 48, 0.15); color: var(--color-exp); }
      
      .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 25px; margin-bottom: 25px; }
      .chart-box { background: var(--bg-panel); border-radius: 24px; padding: 25px; box-shadow: var(--shadow-card); display: flex; flex-direction: column; min-height: 320px; border: 1px solid var(--border); }
      .chart-head { font-weight: 700; font-size: 18px; margin-bottom: 20px; color: var(--text-main); }
      .chart-canv { flex: 1; position: relative; }

      .prog-list { display: flex; flex-direction: column; gap: 10px; }
      .prog-item { display: flex; flex-direction: column; gap: 4px; }
      .prog-info { display: flex; justify-content: space-between; font-size: 13px; font-weight: 600; color: var(--text-main); }
      .prog-bar-bg { width: 100%; height: 6px; background: var(--input-bg); border-radius: 3px; overflow: hidden; border: 1px solid var(--border); box-sizing: border-box; }
      .prog-bar-fill { height: 100%; border-radius: 3px; transition: width 1s ease-out; }

      .search-wrap { position: relative; margin-bottom: 15px; }
      .search-res { position: absolute; top: 100%; left: 0; width: 100%; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 14px; z-index: 100; max-height: 200px; overflow-y: auto; display: none; margin-top: 8px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
      .res-item { padding: 14px 20px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 15px; color: var(--text-main); font-weight: 600; }
      .res-item:hover { background: var(--hover-bg); color: var(--accent); }

      .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.4); z-index: 2000; display: none; align-items: center; justify-content: center; backdrop-filter: blur(4px); }
      .modal-box { background: var(--bg-panel); padding: 25px; border-radius: 20px; width: 340px; border: 1px solid var(--border); box-shadow: 0 20px 60px rgba(0,0,0,0.3); transform: scale(0.95); animation: popIn 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards; }
      @keyframes popIn { to { transform: scale(1); } }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
      .loader { position: absolute; top:0; left:0; width:100%; height:100%; background:rgba(255,255,255,0.01); z-index:50; display:none; }
      .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 12px 24px; border-radius: 8px; opacity: 0; transition: 0.3s; z-index: 3000; font-size: 14px; font-weight: 500; box-shadow: 0 10px 20px -3px rgba(0,0,0,0.2); }
      .toast.show { opacity: 1; bottom: 50px; }
      .toast.success { background: var(--color-inc); }
      .toast.error { background: var(--danger); }
      
      /* --- –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø --- */
      @media (max-width: 900px) { 
          /* –î–µ–ª–∞–µ–º –æ—Ç—Å—Ç—É–ø —Å–Ω–∏–∑—É body –±–æ–ª—å—à–µ, —á—Ç–æ–±—ã –∫–æ–Ω—Ç–µ–Ω—Ç –Ω–µ –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–ª—Å—è –º–µ–Ω—é */
          body { 
            padding: 10px; 
            padding-bottom: calc(80px + env(safe-area-inset-bottom)); 
          }
          
          /* –ë–ª–æ–∫–∏ –≤—ã—Å—Ç—Ä–∞–∏–≤–∞–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω–æ */
          .split-view { 
              flex-direction: column; 
          } 
          
          .panel-left { 
              width: auto; /* –ù–∞ –≤—Å—é —à–∏—Ä–∏–Ω—É */
              border-radius: 16px;
          } 
          
          .panel-right { 
              border-radius: 16px;
          } 

          .kpi-grid { grid-template-columns: 1fr 1fr; }
          .charts-grid { grid-template-columns: 1fr; }

          /* üî• –ú–ï–ù–Æ –°–ù–ò–ó–£ –î–õ–Ø –ú–û–ë–ò–õ–¨–ù–´–• üî• */
          .nav {
              position: fixed;
              bottom: 0;
              left: 0;
              width: 100%;
              margin: 0;
              border-radius: 0;
              border-left: none;
              border-right: none;
              border-bottom: none;
              /* –£—á–∏—Ç—ã–≤–∞–µ–º –ø–æ–¥–±–æ—Ä–æ–¥–æ–∫ iPhone */
              padding-bottom: env(safe-area-inset-bottom);
              background: var(--bg-panel);
              /* –ù–µ–º–Ω–æ–≥–æ –ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç–∏ –¥–ª—è –∫—Ä–∞—Å–æ—Ç—ã */
              backdrop-filter: blur(10px);
          }
          
          /* –£–≤–µ–ª–∏—á–∏–≤–∞–µ–º –∫–Ω–æ–ø–∫–∏ –º–µ–Ω—é –¥–ª—è –ø–∞–ª—å—Ü–∞ */
          .nav-btn {
              padding: 15px;
          }
      }
    </style>
</head>
<body data-theme="light">

    <div id="accessDenied" style="display: none;">
        <div style="font-size: 60px; margin-bottom: 20px;">üîí</div>
        <h2 style="margin: 0 0 10px 0;">–î–æ—Å—Ç—É–ø –∑–∞–ø—Ä–µ—â–µ–Ω</h2>
        <p style="color: var(--text-sub); margin-bottom: 20px;">–£ –≤–∞—Å –Ω–µ—Ç –ø—Ä–∞–≤ –∞–¥–º–∏–Ω–∏—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—è —ç—Ç–æ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è.</p>
        <div id="userIdDisplay" style="font-family: monospace; background: var(--bg-panel); padding: 10px; border-radius: 8px; border: 1px solid var(--border);">
            –í–∞—à ID: ...
        </div>
    </div>

    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
    <div id="loader" class="loader"></div>

    <div class="header">
        <div class="brand-box">
            <svg id="venus" class="venus-icon" viewBox="0 0 100 100" fill="none" xmlns="http://www.w3.org/2000/svg">
                <circle cx="50" cy="50" r="48" fill="url(#venusGrad)" />
                <path d="M10 50C10 50 30 40 50 40C70 40 90 50 90 50" stroke="rgba(255,255,255,0.3)" stroke-width="4"/>
                <path d="M15 30C15 30 35 25 50 25C65 25 85 30 85 30" stroke="rgba(255,255,255,0.2)" stroke-width="3"/>
                <path d="M15 70C15 70 35 75 50 75C65 75 85 70 85 70" stroke="rgba(255,255,255,0.2)" stroke-width="3"/>
                <circle cx="70" cy="30" r="8" fill="rgba(0,0,0,0.1)"/>
                <circle cx="30" cy="65" r="5" fill="rgba(0,0,0,0.1)"/>
                <defs>
                    <radialGradient id="venusGrad" cx="0" cy="0" r="1" gradientUnits="userSpaceOnUse" gradientTransform="translate(30 30) rotate(0) scale(70)">
                        <stop stop-color="#FFD700"/>
                        <stop offset="1" stop-color="#FF8C00"/>
                    </radialGradient>
                </defs>
            </svg>
            <div class="title">–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –í–µ–Ω–µ—Ä–∞</div>
        </div>
        
        <div class="theme-toggle-btn" onclick="toggleTheme(event)">
            <div class="theme-icon icon-sun">‚òÄÔ∏è</div>
            <div class="theme-icon icon-moon">üåë</div>
        </div>
    </div>

    <div class="content-area">
        <div id="splitTab" class="tab-page active">
           <div class="split-view">
                <div class="panel panel-left">
                    <h3 id="formTitle">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
                    <div class="search-wrap">
                        <label id="lblSearch">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="inpName" placeholder="–ü–æ–∏—Å–∫ –∏–ª–∏ –Ω–æ–≤–æ–µ..." autocomplete="off" oninput="showSearch(event); calcTotal()">
                        <div class="search-res" id="searchRes"></div>
                    </div>
                    <div style="display:flex; gap:15px; margin-bottom:25px;">
                        <div style="flex:1">
                           <label>–¶–µ–Ω–∞</label>
                           <div class="qty-wrapper">
                               <button class="qty-btn" onclick="modVal('inpPrice', -100)">‚àí</button>
                               <input type="number" id="inpPrice" class="qty-input" placeholder="0" oninput="calcTotal()">
                               <button class="qty-btn" onclick="modVal('inpPrice', 100)">+</button>
                           </div>
                        </div>
                        <div style="flex:1">
                           <label>–ö–æ–ª-–≤–æ</label>
                           <div class="qty-wrapper">
                               <button class="qty-btn" onclick="modVal('inpQty', -1)">‚àí</button>
                               <input type="number" id="inpQty" class="qty-input" value="1" oninput="calcTotal()">
                               <button class="qty-btn" onclick="modVal('inpQty', 1)">+</button>
                           </div>
                        </div>
                    </div>
                    <div style="text-align:center; margin-top:auto; margin-bottom:15px; padding: 20px; background: var(--input-bg); border-radius: 16px; border: 1px solid var(--border);">
                        <span style="font-size:12px; color:var(--text-sub); text-transform:uppercase; font-weight:700; display:block; margin-bottom:5px;">–ò—Ç–æ–≥–æ –∫ –∑–∞–ø–∏—Å–∏</span>
                        <div id="txtTotal" style="font-size:32px; font-weight:800; color:var(--text-main)">0 ‚ÇΩ</div>
                    </div>
                    <button id="btnAdd" class="btn" onclick="submitEntry()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                </div>

                <div class="panel panel-right">
                    <div class="table-header">
                        <h3 id="tableTitle" style="margin:0">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h3>
                        <button class="btn-refresh" onclick="refreshTable(true)">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                    <div class="grid-wrapper">
                        <table id="mainTable">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                        <div id="emptyMsg" style="padding:40px; text-align:center; color:var(--text-sub);">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="analyticsTab" class="tab-page">
            <div class="analytics-container">
                <div class="filters-row">
                    <select id="anYear" onchange="loadAnalytics()"></select>
                    <select id="anMonth" onchange="loadAnalytics()"></select>
                </div>

                <div class="kpi-grid">
                    <div class="kpi-card">
                        <div class="kpi-title">–í–´–†–£–ß–ö–ê</div>
                        <div class="kpi-val" style="color:var(--color-inc)" id="kpiInc">0</div>
                        <div id="trendInc"></div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">–†–ê–°–•–û–î–´</div>
                        <div class="kpi-val" style="color:var(--color-exp)" id="kpiExp">0</div>
                        <div id="trendExp"></div>
                     </div>
                    <div class="kpi-card">
                        <div class="kpi-title">–ü–†–ò–ë–´–õ–¨</div>
                        <div class="kpi-val" style="color:var(--color-prof)" id="kpiProf">0</div>
                        <div id="trendProf"></div>
                    </div>
                    <div class="kpi-card">
                        <div class="kpi-title">–ü–û–°–ï–¢–ò–¢–ï–õ–ò</div>
                        <div class="kpi-val" style="color:var(--color-vis)" id="kpiVis">0</div>
                        <div id="trendVis"></div>
                    </div>
                </div>

                <div class="charts-grid">
                    <div class="chart-box">
                        <div class="chart-head">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ü—É–ª—å—Å</div>
                        <div class="chart-canv"><canvas id="chartPulse"></canvas></div>
                     </div>
                     <div class="chart-box" style="min-height:300px">
                        <div class="chart-head">–¢–æ–ø –î–æ—Ö–æ–¥–æ–≤</div>
                        <div id="listInc" class="prog-list"></div>
                     </div>
                </div>

                 <div class="charts-grid">
                     <div class="chart-box">
                        <div class="chart-head">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</div>
                        <div class="chart-canv"><canvas id="chartAttendance"></canvas></div>
                     </div>
                     <div class="chart-box" style="min-height:300px">
                        <div class="chart-head">–¢–æ–ø –†–∞—Å—Ö–æ–¥–æ–≤</div>
                        <div id="listExp" class="prog-list"></div>
                     </div>
                </div>
            </div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="switchTab('income')">–ú–∞—Å—Ç–µ—Ä –ö–ª–∞—Å—Å—ã</button>
        <button class="nav-btn" onclick="switchTab('expense')">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</button>
        <button class="nav-btn" onclick="switchTab('analytics')">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
    </div>

    <div id="editModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom:20px; color:var(--text-main)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <input type="hidden" id="editId">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="editName" style="margin-bottom:15px;">
            <div style="display:flex; gap:15px; margin-bottom:20px;">
                <div style="flex:1"><label>–¶–µ–Ω–∞</label><input type="number" id="editPrice"></div>
                <div style="flex:1"><label>–ö–æ–ª-–≤–æ</label><input type="number" id="editQty"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--border-strong);" onclick="document.getElementById('editModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="deleteModal" class="modal-overlay">
        <div class="modal-box">
            <h3 style="margin-bottom:15px; color:var(--text-main)">–£–¥–∞–ª–µ–Ω–∏–µ</h3>
            <p style="color:var(--text-sub); margin-bottom:25px; font-size:14px; line-height:1.5;">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:var(--danger); color:white; margin-top:0;" onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--border-strong); margin-top:0;" onclick="document.getElementById('deleteModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <script>
        // üëá –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–°–´–õ–ö–£ –ü–û–°–õ–ï –î–ï–ü–õ–û–Ø
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyDN6u9RdE9wD0bO4XetH2fmgD-I5XJQo_MhhyIvLGHg3Ub_NCLTUVdjkfAPkNrbF17/exec';
        // üëÜüëÜüëÜ

        // --- –ù–ê–°–¢–†–û–ô–ö–ê –î–û–°–¢–£–ü–ê ---
        const ALLOWED_USERS = [1271410534, 1248292955]; // –Æ–ª–∏—è, –í–∏–∫—Ç–æ—Ä
        
        function checkAccess() {
            // –ü—Ä–æ–≤–µ—Ä–∫–∞: –º—ã –≤–Ω—É—Ç—Ä–∏ Telegram –∏–ª–∏ –Ω–µ—Ç
            if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe) {
                console.warn("–ó–∞–ø—É—â–µ–Ω–æ –Ω–µ –≤ Telegram App. –ü—Ä–æ–≤–µ—Ä–∫–∞ ID –ø—Ä–æ–ø—É—â–µ–Ω–∞ (–¥–ª—è —Ç–µ—Å—Ç–æ–≤).");
                // return true; // –û—Å—Ç–∞–≤—å—Ç–µ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –≤ –±—Ä–∞—É–∑–µ—Ä–µ
            }

            const user = window.Telegram.WebApp.initDataUnsafe?.user;
            
            // –ï—Å–ª–∏ ID –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è –Ω–µ—Ç –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö
            if (!user || !ALLOWED_USERS.includes(user.id)) {
                // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —ç–∫—Ä–∞–Ω –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
                const lockScreen = document.getElementById('accessDenied');
                lockScreen.style.display = 'flex';
                document.getElementById('userIdDisplay').innerText = '–í–∞—à ID: ' + (user ? user.id : '–ù–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω');
                
                // –°–∫—Ä—ã–≤–∞–µ–º –æ—Å–Ω–æ–≤–Ω—ã–µ —ç–ª–µ–º–µ–Ω—Ç—ã –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
                document.querySelector('.header').style.display = 'none';
                document.querySelector('.nav').style.display = 'none';
                document.querySelector('.content-area').style.display = 'none';
                return false;
            }
            return true;
        }

        const IS_GOOGLE = typeof google !== 'undefined' && google.script && google.script.run;
        let currTab = 'income', dataCache = { income: null, expense: null }, config = { incomeItems: [], expenseItems: [] }, charts = {};
        
        let stopAnimationRequest = false, activeRequests = 0, deleteTargetId = null, isAnalyticsLoaded = false, analyticsNeedsRefresh = true; 

        // üî• –£–ù–ò–í–ï–†–°–ê–õ–¨–ù–´–ô –ú–û–°–¢ üî•
        async function runBackend(action, payload = {}) {
            if (IS_GOOGLE) {
                return new Promise((resolve, reject) => {
                    if(action === 'getInitialConfig') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getInitialConfig();
                    else if(action === 'saveTransaction') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).saveTransaction(payload);
                    else if(action === 'getTableData') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getTableData(payload.type);
                    else if(action === 'editTransaction') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).editTransaction(payload);
                    else if(action === 'deleteTransaction') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).deleteTransaction(payload);
                    else if(action === 'getAnalyticsData') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getAnalyticsData(payload.year, payload.monthIdx);
                    else reject("Unknown Func");
                });
            } else {
                if(GAS_URL.includes("–í–ê–®_")) { alert("–û–®–ò–ë–ö–ê: –í—Å—Ç–∞–≤—å —Å—Å—ã–ª–∫—É –≤ index.html!"); throw new Error("No URL"); }
                payload.action = action;
                try {
                    const res = await fetch(GAS_URL, {
                        method: "POST",
                        headers: { "Content-Type": "text/plain;charset=utf-8" },
                        body: JSON.stringify(payload)
                    });
                    const text = await res.text();
                    try { return JSON.parse(text); } catch(e) { throw new Error("Server Error: " + text); }
                } catch(e) { throw e; }
            }
        }

        window.onload = function() {
            // 1. –°–Ω–∞—á–∞–ª–∞ —Ä–∞—Å—à–∏—Ä—è–µ–º –æ–∫–Ω–æ –∏ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∏—Ä—É–µ–º Telegram
            if(window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
            }

            // 2. –ü—Ä–æ–≤–µ—Ä—è–µ–º –¥–æ—Å—Ç—É–ø –ø–µ—Ä–µ–¥ –∑–∞–≥—Ä—É–∑–∫–æ–π –¥–∞–Ω–Ω—ã—Ö
            if (!checkAccess()) return; // –ï—Å–ª–∏ –¥–æ—Å—Ç—É–ø–∞ –Ω–µ—Ç, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Å–∫—Ä–∏–ø—Ç–∞

            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            setLoading(true);
            
            runBackend('getInitialConfig').then(res => {
                config = res;
                const ySel = document.getElementById('anYear'); ySel.innerHTML=''; res.years.forEach(y=>ySel.add(new Option(y,y)));
                const mSel = document.getElementById('anMonth'); mSel.innerHTML=''; mSel.add(new Option('–í–µ—Å—å –≥–æ–¥','all')); res.months.forEach((m,i)=>mSel.add(new Option(m,i))); mSel.value=new Date().getMonth();
                refreshTable(true);
                loadAnalytics(true);
                setLoading(false);
            }).catch(e => {
                showToast("Error: " + e, true);
                setLoading(false);
            });
            const v = document.getElementById('venus');
            v.addEventListener('animationiteration', () => { if (stopAnimationRequest) { v.classList.remove('spinning'); stopAnimationRequest = false; } });
            calcTotal();
        };

        function setLoading(active) {
            const v = document.getElementById('venus');
            if (active) { activeRequests++; stopAnimationRequest = false; v.classList.add('spinning'); } 
            else { activeRequests--;
                if (activeRequests < 0) activeRequests = 0; if (activeRequests === 0) stopAnimationRequest = true;
            }
        }

        function toggleTheme(event) {
            const isDark = document.body.getAttribute('data-theme') === 'dark';
            const newTheme = isDark ? 'light' : 'dark';
            if (!document.startViewTransition) { setTheme(newTheme); return; }
            const rect = event.currentTarget.getBoundingClientRect();
            const x = rect.left + rect.width / 2, y = rect.top + rect.height / 2;
            const endRadius = Math.hypot(Math.max(x, innerWidth - x), Math.max(y, innerHeight - y));
            const transition = document.startViewTransition(() => { setTheme(newTheme); });
            transition.ready.then(() => {
                const dropShadowColor = newTheme === 'light' ? 'rgba(255,255,255,0.8)' : 'rgba(0,0,0,0.5)';
                document.documentElement.animate([{ clipPath: `circle(0px at ${x}px ${y}px)`, filter: `drop-shadow(0 0 0px ${dropShadowColor})` }, { clipPath: `circle(${endRadius}px at ${x}px ${y}px)`, filter: `drop-shadow(0 0 50px ${dropShadowColor})` }], { duration: 700, easing: 'cubic-bezier(0.645, 0.045, 0.355, 1)', pseudoElement: '::view-transition-new(root)' });
            });
        }
        function setTheme(theme) { document.body.setAttribute('data-theme', theme); localStorage.setItem('theme', theme); if(currTab === 'analytics') loadAnalytics(); }

        function switchTab(t) {
            currTab = t;
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active')); event.target.classList.add('active');
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            
            // –°–∫—Ä–æ–ª–ª–∏–º –Ω–∞–≤–µ—Ä—Ö –ø—Ä–∏ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–∏
            window.scrollTo({ top: 0, behavior: 'smooth' });

            if(t === 'analytics') {
                document.getElementById('analyticsTab').classList.add('active');
                if(analyticsNeedsRefresh || !isAnalyticsLoaded) loadAnalytics();
            } else {
                document.getElementById('splitTab').classList.add('active');
                updateUIForTab(t);
                if (dataCache[t]) renderTableFromCache(dataCache[t]);
                else { document.getElementById('tableBody').innerHTML = ''; document.getElementById('emptyMsg').style.display = 'block'; refreshTable(true); }
            }
        }
        function updateUIForTab(t) {
            const isInc = t === 'income';
            document.getElementById('formTitle').innerText = isInc ? '–î–æ–±–∞–≤–∏—Ç—å –ú–∞—Å—Ç–µ—Ä –ö–ª–∞—Å—Å' : '–î–æ–±–∞–≤–∏—Ç—å –†–∞—Å—Ö–æ–¥';
            document.getElementById('lblSearch').innerText = isInc ? '–ù–∞–∑–≤–∞–Ω–∏–µ –ú–ö' : '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ';
            document.getElementById('tableTitle').innerText = isInc ? '–î–æ—Ö–æ–¥—ã (–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏)' : '–†–∞—Å—Ö–æ–¥—ã (–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏)';
            document.getElementById('inpName').value = ''; document.getElementById('inpPrice').value = ''; document.getElementById('inpQty').value = 1;
            calcTotal();
        }

        function renderTableFromCache(data) {
             const tbody = document.getElementById('tableBody'), msg = document.getElementById('emptyMsg');
             if(!data || !data.length) { tbody.innerHTML = ''; msg.style.display = 'block'; msg.innerText = '–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç'; return; }
             msg.style.display = 'none';
             let html = '';
             data.forEach(row => {
                 const rowJson = JSON.stringify(row).replace(/"/g, '&quot;');
                 html += `<tr id="row-${row.rowId}"><td style="color:var(--text-sub);">${row.dateStr}</td><td style="font-weight:600;">${row.name}</td><td style="font-weight:700;">${row.total.toLocaleString()}</td><td class="action-cell"><button class="btn-table btn-edit" onclick="openEdit(${rowJson})">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞—Ç—å</button><button class="btn-table btn-del" onclick="openDelete(${rowJson})">–£–¥–∞–ª–∏—Ç—å</button></td></tr>`;
             });
             tbody.innerHTML = html;
        }

        function refreshTable(force = false, isSilent = false) {
            if(!force && dataCache[currTab]) return;
            const tbody = document.getElementById('tableBody'), msg = document.getElementById('emptyMsg');
            setLoading(true);
            if (!isSilent) { tbody.innerHTML = ''; msg.style.display = 'block'; msg.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...'; }
            runBackend('getTableData', {type: currTab}).then(data => {
                dataCache[currTab] = data; setLoading(false); renderTableFromCache(data); 
            });
        }

        function submitEntry() {
            const name = document.getElementById('inpName').value.trim();
            const price = parseFloat(document.getElementById('inpPrice').value);
            const qty = parseFloat(document.getElementById('inpQty').value);
            if(!name || !price) return;
            
            const total = price * qty;
            const list = currTab === 'income' ? config.incomeItems : config.expenseItems;
            const isNew = !list.includes(name);
            if(isNew) list.push(name);
            const payload = { type: currTab, name: name, price: price, qty: qty, total: total, isNew: isNew };
            // –û–ü–¢–ò–ú–ò–°–¢–ò–ß–ù–´–ô UI
            const tbody = document.getElementById('tableBody');
            document.getElementById('emptyMsg').style.display = 'none';
            const tempId = 'temp-' + Date.now();
            tbody.insertAdjacentHTML('afterbegin', `<tr id="${tempId}" style="background: rgba(var(--accent), 0.05);"><td style="color:var(--text-sub);">${new Date().toLocaleDateString('ru-RU')}</td><td style="font-weight:600;">${name}</td><td style="font-weight:700;">${total.toLocaleString()}</td><td class="action-cell" style="text-align:right;"><span style="font-size:12px; color:var(--text-sub);">–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ...</span></td></tr>`);
            document.getElementById('inpName').value = ''; document.getElementById('inpPrice').value = ''; document.getElementById('inpQty').value = 1; calcTotal();
            const btn = document.getElementById('btnAdd'); btn.disabled = true; setLoading(true);
            runBackend('saveTransaction', payload).then(res => {
                btn.disabled = false; setLoading(false);
                if(res.success) { showToast('–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ'); refreshTable(true, true); analyticsNeedsRefresh = true; loadAnalytics(true); } 
                else { const tempEl = document.getElementById(tempId); if(tempEl) tempEl.remove(); showToast(res.message, true); document.getElementById('inpName').value = name; document.getElementById('inpPrice').value = price; }
            });
        }

        function openEdit(row) {
            document.getElementById('editId').value = row.rowId;
            document.getElementById('editName').value = row.name; document.getElementById('editPrice').value = row.price; document.getElementById('editQty').value = row.qty; document.getElementById('editModal').style.display = 'flex';
        }
        function saveEdit() {
            const id = document.getElementById('editId').value, name = document.getElementById('editName').value, price = parseFloat(document.getElementById('editPrice').value), qty = parseFloat(document.getElementById('editQty').value);
            const payload = { rowId: id, type: currTab, name: name, price: price, qty: qty };
            document.getElementById('editModal').style.display = 'none';
            const row = document.getElementById('row-' + id);
            if(row) { row.cells[1].innerText = name; row.cells[2].innerText = (price * qty).toLocaleString(); row.style.transition = 'background 0.3s'; row.style.background = 'rgba(var(--accent), 0.1)'; setTimeout(() => row.style.background = 'transparent', 1000); }
            setLoading(true);
            runBackend('editTransaction', payload).then(res => {
                setLoading(false);
                if(res.success) { showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); refreshTable(true, true); analyticsNeedsRefresh = true; loadAnalytics(true); } else { showToast(res.message, true); refreshTable(true, false); }
            });
        }
        function openDelete(row) { deleteTargetId = row.rowId; document.getElementById('deleteModal').style.display = 'flex'; }
        function confirmDelete() {
            if(!deleteTargetId) return;
            document.getElementById('deleteModal').style.display = 'none';
            const rowElement = document.getElementById('row-' + deleteTargetId);
            if (rowElement) { rowElement.style.transition = 'opacity 0.3s'; rowElement.style.opacity = '0'; setTimeout(() => { if(rowElement) rowElement.remove(); }, 300); }
            setLoading(true);
            runBackend('deleteTransaction', {rowId: deleteTargetId, type: currTab}).then(res => {
                setLoading(false);
                if(res.success) { showToast('–£–¥–∞–ª–µ–Ω–æ'); refreshTable(true, true); analyticsNeedsRefresh = true; loadAnalytics(true); } else { showToast(res.message, true); refreshTable(true, false); }
            });
        }

        function loadAnalytics(isSilent = false) {
            const y=document.getElementById('anYear').value, m=document.getElementById('anMonth').value;
            setLoading(true);
            runBackend('getAnalyticsData', {year: y, monthIdx: m}).then(d => {
                setLoading(false); isAnalyticsLoaded = true; analyticsNeedsRefresh = false;
                renderKPI('kpiInc', d.current.income, d.growth.income, '‚ÇΩ', 'trend-up'); renderKPI('kpiExp', d.current.expense, d.growth.expense, '‚ÇΩ', 'trend-down'); renderKPI('kpiProf', d.current.profit, d.growth.profit, '‚ÇΩ', 'trend-up'); renderKPI('kpiVis', d.current.visitors, d.growth.visitors, '—á–µ–ª', 'trend-up');
                renderAreaChart('chartPulse', d.pulse.labels, [{ label:'–î–æ—Ö–æ–¥', data:d.pulse.income, borderColor:'#34C759', bg:'rgba(52, 199, 89, 0.1)' }, { label:'–†–∞—Å—Ö–æ–¥', data:d.pulse.expense, borderColor:'#FF3B30', bg:'rgba(255, 59, 48, 0.1)' }]);
                renderAreaChart('chartAttendance', d.attendance.labels, [{ label:'–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏', data:d.attendance.data, borderColor:'#AF52DE', bg:'rgba(175, 82, 222, 0.1)' }]);
                renderProgressList('listInc', d.pieIncome.labels, d.pieIncome.data, '#34C759');
                renderProgressList('listExp', d.pieExpense.labels, d.pieExpense.data, '#FF3B30');
            });
        }
        function renderKPI(id, val, growth, suff, colorCls) {
            document.getElementById(id).innerText = val.toLocaleString() + ' ' + suff;
            const el = document.getElementById(id.replace('kpi','trend'));
            if(el) { const arr = growth>=0?'‚Üó':'‚Üò'; const cls = (growth>=0 && colorCls==='trend-up') || (growth<0 && colorCls==='trend-down') ? 'trend-up' : 'trend-down'; let finalCls = cls; if(id==='kpiExp') finalCls = (growth > 0) ? 'trend-down' : 'trend-up'; el.className = `kpi-trend ${finalCls}`; el.innerText = `${arr} ${Math.abs(growth)}%`; }
        }
        function renderAreaChart(id, labels, datasets) {
            if(charts[id]) charts[id].destroy();
            const ctx = document.getElementById(id).getContext('2d');
            const ds = datasets.map(d => ({ label: d.label, data: d.data, borderColor: d.borderColor, backgroundColor: d.bg, borderWidth: 2, tension: 0.4, fill: true, pointRadius: 0, pointHoverRadius: 6 }));
            charts[id] = new Chart(ctx, { type: 'line', data: { labels: labels, datasets: ds }, options: { responsive: true, maintainAspectRatio: false, interaction: { mode: 'index', intersect: false }, plugins: { legend: { display: false }, tooltip: { backgroundColor: '#1C1C1E', titleColor: '#fff', bodyColor: '#fff', cornerRadius: 8, padding: 10 } }, scales: { x: { grid: { display: false }, ticks: { color: '#8E8E93', font:{size:10} } }, y: { display: false } } } });
        }
        function renderProgressList(id, labels, data, color) {
            const el = document.getElementById(id);
            el.innerHTML = ''; if(!data.length) { el.innerHTML='<div style="color:var(--text-sub); font-size:13px">–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö</div>'; return; }
            const max = Math.max(...data);
            labels.forEach((lbl, i) => { const val = data[i]; const pct = (val / max) * 100; const html = `<div class="prog-item"><div class="prog-info"><span>${lbl}</span><span>${val.toLocaleString()}</span></div><div class="prog-bar-bg"><div class="prog-bar-fill" style="width:${pct}%; background:${color}"></div></div></div>`; el.insertAdjacentHTML('beforeend', html); });
        }
        function showSearch(e) {
            const val = e.target.value.toLowerCase();
            const box = document.getElementById('searchRes'); box.innerHTML = ''; if(!val) { box.style.display='none'; return; }
            const src = currTab==='income' ? config.incomeItems : config.expenseItems;
            const res = src.filter(s => s.toLowerCase().includes(val)).slice(0,5);
            if(res.length) { box.style.display='block'; res.forEach(r => { const d = document.createElement('div'); d.className='res-item'; d.innerText=r; d.onclick=()=>{ document.getElementById('inpName').value=r; box.style.display='none'; calcTotal(); }; box.appendChild(d); });
            } else box.style.display='none';
        }
        function modVal(id, d) { const el = document.getElementById(id);
            let v = parseFloat(el.value)||0; v+=d; if(v<0) v=0; if(id==='inpQty' && v<1) v=1; el.value=v; calcTotal();
        }
        function calcTotal() {
            const priceVal = document.getElementById('inpPrice').value, nameVal = document.getElementById('inpName').value.trim();
            const p = parseFloat(priceVal); const q = parseFloat(document.getElementById('inpQty').value);
            document.getElementById('txtTotal').innerText = ((p*q)||0).toLocaleString() + ' ‚ÇΩ'; const btn = document.getElementById('btnAdd');
            if (!nameVal) { btn.innerText = "–£–∫–∞–∂–∏—Ç–µ –Ω–∞–∑–≤–∞–Ω–∏–µ"; btn.style.opacity = "0.6";
            } else if (!priceVal || isNaN(p) || p === 0) { btn.innerText = "–£–∫–∞–∂–∏—Ç–µ —Ü–µ–Ω—É"; btn.style.opacity = "0.6";
            } else { btn.innerText = "–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å"; btn.style.opacity = "1"; }
        }
        function showToast(m, err) { const t = document.getElementById('toast');
            t.innerText=m; t.className = err ? 'toast error show' : 'toast success show'; setTimeout(() => t.className='toast', 3000);
        }
    </script>
</body>
</html>
