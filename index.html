<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Venus Workshop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root { 
        --bg-app: #F2F2F7;
        --bg-panel: linear-gradient(180deg, #FFFFFF 0%, #F5F7FA 100%);      
        --text-main: #1C1C1E;     
        --text-sub: #8E8E93;      
        --accent: #007AFF;        
        --border: rgba(0,0,0,0.08); 
        --border-strong: #C7C7CC;
        --input-bg: #FFFFFF;      
        
        --color-inc: #34C759;
        --color-exp: #FF3B30;     
        --color-prof: #5856D6;    
        --color-vis: #AF52DE;
        
        --danger: #FF3B30;
        --shadow-card: 0 4px 12px rgba(0,0,0,0.06);
        --radius: 20px;
        --scroll-thumb: #C7C7CC;
      }
      
      [data-theme="dark"] { 
        --bg-app: #0f172a;
        --bg-panel: #1e293b; 
        --text-main: #f8fafc;     
        --text-sub: #94a3b8;      
        --accent: #60a5fa;        
        --border: #334155;        
        --border-strong: #475569;
        --input-bg: #0f172a;      
        
        --shadow-card: 0 4px 20px rgba(0,0,0,0.4);
        --color-inc: #4ade80;     
        --color-exp: #f87171;     
        --color-prof: #818cf8;    
        --color-vis: #c084fc;     
        --scroll-thumb: #475569;
      }
      
      * { -webkit-tap-highlight-color: transparent; box-sizing: border-box; }
      
      body { 
          margin: 0; padding: 20px; 
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
          background-color: var(--bg-app); 
          color: var(--text-main); 
          height: 100vh; height: 100dvh; 
          overflow: hidden; 
          display:flex; flex-direction:column;
          -webkit-font-smoothing: antialiased; font-weight: 500;
      }
      
      /* --- HEADER --- */
      .header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; flex-shrink: 0; }
      .brand-box { display: flex; align-items: center; gap: 12px; }
      .title { margin: 0; font-size: 24px; font-weight: 800; color: var(--text-main); letter-spacing: -0.5px; }
      .venus-icon { width: 42px; height: 42px; cursor: pointer; transition: transform 0.5s ease; z-index: 5; }
      .venus-icon.spinning { animation: spinInfinite 1.5s linear infinite; }
      @keyframes spinInfinite { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

      /* --- NAV (Bottom Bar) --- */
      .nav { 
          display: flex; background: var(--bg-panel); padding: 4px; 
          border-radius: 14px; flex-shrink: 0; 
          box-shadow: var(--shadow-card); border: 1px solid var(--border); 
          position: relative; z-index: 1000;
      }
      .nav-btn { flex: 1; padding: 10px; border: none; background: transparent; color: var(--text-sub); border-radius: 10px; cursor: pointer; font-weight: 600; text-align: center; transition: 0.2s; font-size: 14px; z-index: 2; position: relative; display: flex; align-items: center; justify-content: center; gap:8px;}
      .nav-btn.active { color: var(--text-main); background: var(--bg-app); box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
      [data-theme="dark"] .nav-btn.active { background: #334155; box-shadow: none; }
      .nav-btn svg { width: 18px; height: 18px; fill: currentColor; opacity: 0.7; }
      .nav-btn.active svg { opacity: 1; color: var(--accent); fill: var(--accent); }

      /* --- CONTENT AREA & SLIDE TRANSITIONS --- */
      .content-area { 
          flex: 1; position: relative; overflow: hidden; 
          border-radius: var(--radius); width: 100%;
          touch-action: pan-y; /* –ü–æ–∑–≤–æ–ª—è–µ–º –≤–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å–∫—Ä–æ–ª–ª, –≥–æ—Ä–∏–∑–æ–Ω—Ç–∞–ª—å–Ω—ã–π –ø–µ—Ä–µ—Ö–≤–∞—Ç—ã–≤–∞–µ–º JS */
      }
      
      .tab-page { 
          position: absolute; top: 0; left: 0; width: 100%; height: 100%;
          transition: transform 0.3s cubic-bezier(0.25, 0.46, 0.45, 0.94), opacity 0.3s;
          display: none; opacity: 0; overflow-y: auto; overflow-x: hidden;
          padding-bottom: 80px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ –Ω–∞–≤–∏–≥–∞—Ü–∏—é –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º */
      }
      
      .tab-page.active { display: block; opacity: 1; transform: translateX(0); z-index: 2; }
      
      /* –ê–Ω–∏–º–∞—Ü–∏–∏ –≤—Ö–æ–¥–∞/–≤—ã—Ö–æ–¥–∞ */
      .tab-page.slide-out-left { display: block; transform: translateX(-100%); opacity: 0; z-index: 1; }
      .tab-page.slide-out-right { display: block; transform: translateX(100%); opacity: 0; z-index: 1; }
      .tab-page.slide-in-left { display: block; animation: slideInLeft 0.3s forwards; z-index: 3; }
      .tab-page.slide-in-right { display: block; animation: slideInRight 0.3s forwards; z-index: 3; }

      @keyframes slideInLeft { from { transform: translateX(-100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }
      @keyframes slideInRight { from { transform: translateX(100%); opacity: 0; } to { transform: translateX(0); opacity: 1; } }

      /* --- PANELS & FORMS --- */
      .panel { background: var(--bg-panel); border-radius: var(--radius); box-shadow: var(--shadow-card); overflow: hidden; display: flex; flex-direction: column; border: 1px solid var(--border); margin-bottom: 20px; }
      .panel-inner { padding: 20px; }
      
      h3 { margin-top: 0; font-size: 18px; font-weight: 700; color: var(--text-main); margin-bottom: 15px; }
      label { font-size: 12px; font-weight: 700; color: var(--text-sub); margin-bottom: 6px; display: block; letter-spacing: 0.02em; }
      
      input { width: 100%; padding: 14px; border-radius: 12px; border: 1px solid var(--border-strong); background-color: var(--input-bg); color: var(--text-main); font-size: 15px; outline:none; transition:0.2s; font-weight: 600; font-family: 'Inter', sans-serif; }
      input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1); }
      
      /* –°—Ç–∏–ª–∏ –¥–ª—è –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ –∏ —Ü–µ–Ω—ã */
      .qty-wrapper { display: flex; align-items: center; background: var(--input-bg); border: 1px solid var(--border-strong); border-radius: 12px; overflow: hidden; padding: 2px; }
      .qty-btn { width: 44px; height: 44px; background: transparent; border: none; color: var(--text-main); font-size: 20px; cursor: pointer; border-radius: 10px; transition: 0.2s; font-weight: 600; }
      .qty-btn:active { background: rgba(0,0,0,0.1); transform: scale(0.9); }
      .qty-input { text-align: center; border: none; font-weight: 700; font-size: 18px; flex: 1; padding: 0; background: transparent; color: var(--text-main); }
      .qty-input:focus { box-shadow: none; border: none; }

      /* –ö–Ω–æ–ø–∫–∞ "–î–æ–±–∞–≤–∏—Ç—å" */
      .btn { width: 100%; padding: 16px; background: var(--accent); color: white; border: none; border-radius: 16px; font-weight: 700; cursor: pointer; margin-top: 20px; font-size: 16px; transition: transform 0.1s, background 0.2s; }
      .btn:active { transform: scale(0.96); opacity: 0.9; }
      /* –¢—Ä—è—Å–∫–∞ –ø—Ä–∏ –æ—à–∏–±–∫–µ */
      .shake { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; background-color: var(--danger) !important; }
      @keyframes shake { 
          10%, 90% { transform: translate3d(-1px, 0, 0); } 
          20%, 80% { transform: translate3d(2px, 0, 0); } 
          30%, 50%, 70% { transform: translate3d(-4px, 0, 0); } 
          40%, 60% { transform: translate3d(4px, 0, 0); } 
      }

      /* --- NEW LIST STYLE (No horizontal scroll) --- */
      .card-list { display: flex; flex-direction: column; gap: 12px; padding-bottom: 20px; }
      .card-item { 
          background: var(--input-bg); border: 1px solid var(--border); border-radius: 16px; padding: 15px; 
          display: flex; flex-direction: column; gap: 8px; position: relative;
      }
      .card-row { display: flex; justify-content: space-between; align-items: center; }
      .card-date { font-size: 12px; color: var(--text-sub); font-weight: 600; }
      .card-title { font-size: 15px; font-weight: 700; color: var(--text-main); white-space: nowrap; overflow: hidden; text-overflow: ellipsis; max-width: 65%; }
      .card-price { font-size: 16px; font-weight: 800; color: var(--text-main); }
      .card-actions { display: flex; gap: 8px; }
      .btn-icon { 
          width: 36px; height: 36px; border-radius: 10px; border: 1px solid var(--border-strong); 
          background: transparent; display: flex; align-items: center; justify-content: center; color: var(--text-sub);
          transition: 0.2s;
      }
      .btn-icon svg { width: 18px; height: 18px; fill: currentColor; }
      .btn-icon:active { transform: scale(0.9); }
      .btn-edit:active { background: var(--accent); color: white; border-color: var(--accent); }
      .btn-del:active { background: var(--danger); color: white; border-color: var(--danger); }

      /* --- ANALYTICS PICKER (3D WHEEL) --- */
      .picker-trigger { 
          background: var(--bg-panel); border: 1px solid var(--border); padding: 12px; border-radius: 12px;
          text-align: center; font-weight: 700; color: var(--text-main); margin-bottom: 20px;
      }
      .picker-overlay {
          position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.5);
          z-index: 5000; display: none; align-items: flex-end; justify-content: center; backdrop-filter: blur(4px);
      }
      .picker-container {
          width: 100%; background: var(--bg-panel); border-radius: 24px 24px 0 0; padding: 20px 0;
          box-shadow: 0 -10px 40px rgba(0,0,0,0.2); animation: slideUp 0.3s cubic-bezier(0.16, 1, 0.3, 1) forwards;
      }
      .picker-header { display: flex; justify-content: space-between; padding: 0 20px 10px 20px; border-bottom: 1px solid var(--border); }
      .picker-btn { color: var(--accent); font-weight: 600; font-size: 16px; cursor: pointer; }
      
      .wheel-container { height: 200px; overflow-y: scroll; scroll-snap-type: y mandatory; position: relative; padding: 80px 0; -webkit-overflow-scrolling: touch; }
      /* –ì—Ä–∞–¥–∏–µ–Ω—Ç—ã –¥–ª—è —ç—Ñ—Ñ–µ–∫—Ç–∞ –±–∞—Ä–∞–±–∞–Ω–∞ */
      .wheel-container::before { content:''; position: absolute; top: 0; left: 0; width: 100%; height: 80px; background: linear-gradient(to bottom, var(--bg-panel), transparent); pointer-events: none; z-index: 2; }
      .wheel-container::after { content:''; position: absolute; bottom: 0; left: 0; width: 100%; height: 80px; background: linear-gradient(to top, var(--bg-panel), transparent); pointer-events: none; z-index: 2; }
      
      .wheel-item { 
          height: 40px; display: flex; align-items: center; justify-content: center; 
          scroll-snap-align: center; font-size: 16px; color: var(--text-sub); transition: 0.2s;
          transform-origin: center; opacity: 0.5;
      }
      /* –ê–∫—Ç–∏–≤–Ω—ã–π —ç–ª–µ–º–µ–Ω—Ç (–ø–æ —Ü–µ–Ω—Ç—Ä—É) - —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç—Å—è JS-–æ–º —á–µ—Ä–µ–∑ IntersectionObserver –∏–ª–∏ —Å–∫—Ä–æ–ª–ª –∏–≤–µ–Ω—Ç—ã, –Ω–æ –¥–ª—è –ø—Ä–æ—Å—Ç–æ—Ç—ã CSS snap –ø–æ–º–æ–≥–∞–µ—Ç */
      .wheel-highlight {
          position: absolute; top: 50%; left: 0; width: 100%; height: 40px; margin-top: -20px;
          border-top: 1px solid var(--border-strong); border-bottom: 1px solid var(--border-strong);
          pointer-events: none; z-index: 1; background: rgba(0,0,0,0.03);
      }

      /* KPI & Charts */
      .kpi-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; margin-bottom: 20px; }
      .kpi-card { background: var(--bg-panel); padding: 15px; border-radius: 16px; border: 1px solid var(--border); }
      .kpi-title { font-size: 10px; color: var(--text-sub); text-transform: uppercase; font-weight: 700; }
      .kpi-val { font-size: 20px; font-weight: 800; color: var(--text-main); margin: 4px 0; }
      .kpi-trend { font-size: 11px; padding: 2px 6px; border-radius: 10px; display: inline-block; font-weight: 700; }
      .trend-up { background: rgba(52, 199, 89, 0.15); color: var(--color-inc); }
      .trend-down { background: rgba(255, 59, 48, 0.15); color: var(--color-exp); }
      
      .chart-box { background: var(--bg-panel); padding: 15px; border-radius: 16px; border: 1px solid var(--border); margin-bottom: 15px; min-height: 250px; }
      
      /* Search Overlay */
      .search-res { position: absolute; top: 100%; left: 0; width: 100%; background: var(--bg-panel); border: 1px solid var(--border); border-radius: 14px; z-index: 100; max-height: 200px; overflow-y: auto; display: none; margin-top: 5px; box-shadow: 0 10px 40px rgba(0,0,0,0.15); }
      .res-item { padding: 12px 15px; border-bottom: 1px solid var(--border); font-size: 15px; font-weight: 600; }
      
      /* Loader & Toast */
      .loader { position: fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.05); z-index:9000; display:none; }
      .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: #1e293b; color: white; padding: 10px 20px; border-radius: 20px; opacity: 0; transition: 0.3s; z-index: 9999; font-weight: 600; font-size: 14px; pointer-events: none; margin-top: -60px; }
      .toast.show { opacity: 1; margin-top: 0; }
      .toast.error { background: var(--danger); }

      /* Mobile adjustments */
      @media (max-width: 768px) {
        body { padding: 10px; }
        .nav { position: fixed; bottom: 20px; left: 20px; right: 20px; width: auto; margin: 0; }
        .content-area { padding-bottom: 90px; } /* Space for nav */
      }
      
      @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
    </style>
</head>
<body data-theme="light">

    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>
    <div id="loader" class="loader"></div>

    <div class="header">
        <div class="brand-box">
            <svg id="venus" onclick="toggleTheme()" class="venus-icon" viewBox="0 0 100 100" fill="none">
                <circle cx="50" cy="50" r="48" fill="url(#venusGrad)" />
                <path d="M10 50C10 50 30 40 50 40C70 40 90 50 90 50" stroke="rgba(255,255,255,0.3)" stroke-width="4"/>
                <path d="M15 30C15 30 35 25 50 25C65 25 85 30 85 30" stroke="rgba(255,255,255,0.2)" stroke-width="3"/>
                <path d="M15 70C15 70 35 75 50 75C65 75 85 70 85 70" stroke="rgba(255,255,255,0.2)" stroke-width="3"/>
                <defs><radialGradient id="venusGrad" cx="0" cy="0" r="1" gradientTransform="translate(30 30) rotate(0) scale(70)"><stop stop-color="#FFD700"/><stop offset="1" stop-color="#FF8C00"/></radialGradient></defs>
            </svg>
            <div class="title">–í–µ–Ω–µ—Ä–∞</div>
        </div>
    </div>

    <div class="content-area" id="mainContainer">
        
        <div id="tab-income" class="tab-page active">
             <div class="panel">
                <div class="panel-inner">
                    <h3>–ù–æ–≤—ã–π –ú–∞—Å—Ç–µ—Ä –ö–ª–∞—Å—Å</h3>
                    <div style="position:relative; margin-bottom:15px;">
                        <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="incName" placeholder="–ü–æ–∏—Å–∫ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ..." autocomplete="off" onkeyup="handleKeyInput(event, 'incName', 'incRes'); calcTotal('inc');">
                        <div class="search-res" id="incRes"></div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1">
                            <label>–¶–µ–Ω–∞</label>
                            <div class="qty-wrapper">
                                <button class="qty-btn" onclick="modVal('incPrice', -100, 'inc')">‚àí</button>
                                <input type="number" id="incPrice" class="qty-input" placeholder="0" onkeyup="handleKeyInput(event); calcTotal('inc');">
                                <button class="qty-btn" onclick="modVal('incPrice', 100, 'inc')">+</button>
                            </div>
                        </div>
                        <div style="flex:0.7">
                            <label>–ö–æ–ª-–≤–æ</label>
                            <div class="qty-wrapper">
                                <button class="qty-btn" onclick="modVal('incQty', -1, 'inc')">‚àí</button>
                                <input type="number" id="incQty" class="qty-input" value="1" onkeyup="handleKeyInput(event); calcTotal('inc');">
                                <button class="qty-btn" onclick="modVal('incQty', 1, 'inc')">+</button>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:center; padding:10px; background:var(--input-bg); border-radius:12px; border:1px solid var(--border);">
                         <span style="font-size:10px; color:var(--text-sub); text-transform:uppercase;">–ò—Ç–æ–≥–æ</span>
                         <div id="incTotal" style="font-size:22px; font-weight:800;">0 ‚ÇΩ</div>
                    </div>
                    <button id="btnInc" class="btn" onclick="submitEntry('income')">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
             </div>
             
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:0 5px;">
                <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h3>
                <span onclick="refreshTable('income')" style="color:var(--accent); font-size:12px; font-weight:600; cursor:pointer;">–û–±–Ω–æ–≤–∏—Ç—å</span>
             </div>
             <div id="list-income" class="card-list"></div>
        </div>

        <div id="tab-expense" class="tab-page">
             <div class="panel">
                <div class="panel-inner">
                    <h3>–ù–æ–≤—ã–π –†–∞—Å—Ö–æ–¥</h3>
                    <div style="position:relative; margin-bottom:15px;">
                        <label>–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="expName" placeholder="–ü–æ–∏—Å–∫ –∏–ª–∏ –Ω–∞–∑–≤–∞–Ω–∏–µ..." autocomplete="off" onkeyup="handleKeyInput(event, 'expName', 'expRes'); calcTotal('exp');">
                        <div class="search-res" id="expRes"></div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:15px;">
                        <div style="flex:1">
                            <label>–¶–µ–Ω–∞</label>
                            <div class="qty-wrapper">
                                <button class="qty-btn" onclick="modVal('expPrice', -100, 'exp')">‚àí</button>
                                <input type="number" id="expPrice" class="qty-input" placeholder="0" onkeyup="handleKeyInput(event); calcTotal('exp');">
                                <button class="qty-btn" onclick="modVal('expPrice', 100, 'exp')">+</button>
                            </div>
                        </div>
                        <div style="flex:0.7">
                            <label>–ö–æ–ª-–≤–æ</label>
                            <div class="qty-wrapper">
                                <button class="qty-btn" onclick="modVal('expQty', -1, 'exp')">‚àí</button>
                                <input type="number" id="expQty" class="qty-input" value="1" onkeyup="handleKeyInput(event); calcTotal('exp');">
                                <button class="qty-btn" onclick="modVal('expQty', 1, 'exp')">+</button>
                            </div>
                        </div>
                    </div>
                    <div style="text-align:center; padding:10px; background:var(--input-bg); border-radius:12px; border:1px solid var(--border);">
                         <span style="font-size:10px; color:var(--text-sub); text-transform:uppercase;">–ò—Ç–æ–≥–æ</span>
                         <div id="expTotal" style="font-size:22px; font-weight:800;">0 ‚ÇΩ</div>
                    </div>
                    <button id="btnExp" class="btn" onclick="submitEntry('expense')">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>
             </div>
             
             <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px; padding:0 5px;">
                <h3>–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h3>
                <span onclick="refreshTable('expense')" style="color:var(--accent); font-size:12px; font-weight:600; cursor:pointer;">–û–±–Ω–æ–≤–∏—Ç—å</span>
             </div>
             <div id="list-expense" class="card-list"></div>
        </div>

        <div id="tab-analytics" class="tab-page">
            <div style="display:flex; gap:10px; margin-bottom:15px;">
                <div class="picker-trigger" style="flex:1" onclick="openPicker('year')"><span id="txtYear">–ì–æ–¥</span></div>
                <div class="picker-trigger" style="flex:1" onclick="openPicker('month')"><span id="txtMonth">–ú–µ—Å—è—Ü</span></div>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card"><div class="kpi-title">–í–´–†–£–ß–ö–ê</div><div class="kpi-val" style="color:var(--color-inc)" id="kpiInc">0</div><div id="trendInc"></div></div>
                <div class="kpi-card"><div class="kpi-title">–†–ê–°–•–û–î–´</div><div class="kpi-val" style="color:var(--color-exp)" id="kpiExp">0</div><div id="trendExp"></div></div>
                <div class="kpi-card"><div class="kpi-title">–ü–†–ò–ë–´–õ–¨</div><div class="kpi-val" style="color:var(--color-prof)" id="kpiProf">0</div><div id="trendProf"></div></div>
                <div class="kpi-card"><div class="kpi-title">–ö–õ–ò–ï–ù–¢–´</div><div class="kpi-val" style="color:var(--color-vis)" id="kpiVis">0</div><div id="trendVis"></div></div>
            </div>

            <div class="chart-box"><h3 style="font-size:16px;">–§–∏–Ω–∞–Ω—Å–æ–≤—ã–π –ü—É–ª—å—Å</h3><canvas id="chartPulse"></canvas></div>
            <div class="chart-box"><h3 style="font-size:16px;">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</h3><canvas id="chartAttendance"></canvas></div>
        </div>

    </div>

    <div id="pickerModal" class="picker-overlay">
        <div class="picker-container">
            <div class="picker-header">
                <span class="picker-btn" style="color:var(--text-sub)" onclick="closePicker(false)">–û—Ç–º–µ–Ω–∞</span>
                <span class="picker-btn" onclick="closePicker(true)">–ì–æ—Ç–æ–≤–æ</span>
            </div>
            <div class="wheel-highlight"></div>
            <div class="wheel-container" id="wheelBox">
                </div>
        </div>
    </div>

    <div class="nav">
        <button class="nav-btn active" onclick="goToTab(0)">
            <svg viewBox="0 0 24 24"><path d="M21 18V19C21 20.1 20.1 21 19 21H5C3.89 21 3 20.1 3 19V5C3 3.9 3.89 3 5 3H19C20.1 3 21 3.9 21 5V6H12C10.89 6 10 6.9 10 8V16C10 17.1 10.89 18 12 18H21ZM12 16H22V8H12V16ZM16 13.5C15.17 13.5 14.5 12.83 14.5 12C14.5 11.17 15.17 10.5 16 10.5C16.83 10.5 17.5 11.17 17.5 12C17.5 12.83 16.83 13.5 16 13.5Z"/></svg>
            –ú–ö
        </button>
        <button class="nav-btn" onclick="goToTab(1)">
            <svg viewBox="0 0 24 24"><path d="M7 18c-1.1 0-1.99.9-1.99 2S5.9 22 7 22s2-.9 2-2-.9-2-2-2zM1 2v2h2l3.6 7.59-1.35 2.45c-.16.28-.25.61-.25.96 0 1.1.9 2 2 2h12v-2H7.42c-.14 0-.25-.11-.25-.25l.03-.12.9-1.63h7.45c.75 0 1.41-.41 1.75-1.03l3.58-6.49c.08-.14.12-.31.12-.48 0-.55-.45-1-1-1H5.21l-.94-2H1zm16 16c-1.1 0-1.99.9-1.99 2s.89 2 1.99 2 2-.9 2-2-.9-2-2-2z"/></svg>
            –†–∞—Å—Ö–æ–¥
        </button>
        <button class="nav-btn" onclick="goToTab(2)">
            <svg viewBox="0 0 24 24"><path d="M19 3H5C3.9 3 3 3.9 3 5V19C3 20.1 3.9 21 5 21H19C20.1 21 21 20.1 21 19V5C21 3.9 20.1 3 19 3ZM9 17H7V10H9V17ZM13 17H11V7H13V17ZM17 17H15V13H17V17Z"/></svg>
            –ò–Ω—Ñ–æ
        </button>
    </div>

    <script>
        // üëáüëáüëá –í–°–¢–ê–í–¨ –°–í–û–Æ –°–°–´–õ–ö–£ –ù–ò–ñ–ï
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbxHs2iY8VjvE_oHjAkzyMGux57T9Ui3o6GCitV2BWVgHMq17-19S_5E1L7jrW9DcYO8/exec';
        // üëÜüëÜüëÜ

        const tg = window.Telegram.WebApp;
        const haptic = tg.HapticFeedback;

        let curTabIdx = 0;
        const tabs = ['income', 'expense', 'analytics'];
        let touchStartX = 0;
        let touchEndX = 0;
        
        // Data & Config
        let config = { incomeItems: [], expenseItems: [] };
        let dataCache = { income: null, expense: null };
        let selYear = new Date().getFullYear();
        let selMonth = new Date().getMonth();
        const monthNames = ["–Ø–Ω–≤–∞—Ä—å", "–§–µ–≤—Ä–∞–ª—å", "–ú–∞—Ä—Ç", "–ê–ø—Ä–µ–ª—å", "–ú–∞–π", "–ò—é–Ω—å", "–ò—é–ª—å", "–ê–≤–≥—É—Å—Ç", "–°–µ–Ω—Ç—è–±—Ä—å", "–û–∫—Ç—è–±—Ä—å", "–ù–æ—è–±—Ä—å", "–î–µ–∫–∞–±—Ä—å"];
        let availableYears = [selYear];

        // --- INIT ---
        window.onload = function() {
            if(tg) { tg.expand(); tg.ready(); }
            
            // Theme check
            const saved = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', saved);

            // Setup Swipe
            const container = document.getElementById('mainContainer');
            container.addEventListener('touchstart', e => { touchStartX = e.changedTouches[0].screenX; }, {passive: true});
            container.addEventListener('touchend', e => { 
                touchEndX = e.changedTouches[0].screenX; 
                handleSwipe(); 
            }, {passive: true});

            // Setup Throttled Haptic for Scrolling (Pseudo)
            setupScrollHaptics();

            // Load Data
            fetchInitialConfig();
            refreshTable('income', true);
        };

        // --- HAPTICS HELPERS ---
        function vib(type) {
            if(!tg) return;
            // impactLight, impactMedium, impactHeavy, selectionChanged, notificationOccurred
            if(type === 'light') haptic.impactOccurred('light');
            else if(type === 'medium') haptic.impactOccurred('medium');
            else if(type === 'selection') haptic.selectionChanged();
            else if(type === 'error') haptic.notificationOccurred('error');
            else if(type === 'success') haptic.notificationOccurred('success');
        }

        // --- NAVIGATION & SWIPES ---
        function goToTab(idx) {
            if(idx === curTabIdx) return;
            vib('medium');

            const current = document.getElementById('tab-' + tabs[curTabIdx]);
            const next = document.getElementById('tab-' + tabs[idx]);
            const btns = document.querySelectorAll('.nav-btn');

            // Nav Highlight
            btns.forEach(b => b.classList.remove('active'));
            btns[idx].classList.add('active');

            // Animation Direction
            const direction = idx > curTabIdx ? 'right' : 'left'; // moving to...
            
            // Clean classes
            current.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
            next.classList.remove('active', 'slide-in-left', 'slide-in-right', 'slide-out-left', 'slide-out-right');
            
            // Apply anim
            if(direction === 'right') {
                current.classList.add('slide-out-left');
                next.classList.add('slide-in-right');
            } else {
                current.classList.add('slide-out-right');
                next.classList.add('slide-in-left');
            }

            curTabIdx = idx;
            
            if(tabs[curTabIdx] === 'analytics') loadAnalytics();
        }

        function handleSwipe() {
            const diff = touchEndX - touchStartX;
            if(Math.abs(diff) < 80) return; // Threshold

            if(diff < 0) {
                // Swipe Left -> Next Tab
                let next = curTabIdx + 1;
                if(next >= tabs.length) next = 0; // Loop
                goToTab(next);
            } else {
                // Swipe Right -> Prev Tab
                let prev = curTabIdx - 1;
                if(prev < 0) prev = tabs.length - 1; // Loop
                goToTab(prev);
            }
        }

        // --- FORMS & INPUTS ---
        function handleKeyInput(e, id, resId) {
            // Vib on every key (except modifiers)
            if(!e.ctrlKey && !e.altKey && !e.metaKey) vib('light');
            
            if(id && resId) {
                // Search logic
                const val = e.target.value.toLowerCase();
                const box = document.getElementById(resId);
                const list = (id === 'incName') ? config.incomeItems : config.expenseItems;
                
                if(!val) { box.style.display='none'; return; }
                const found = list.filter(x => x.toLowerCase().includes(val)).slice(0,4);
                
                if(found.length) {
                    box.innerHTML = '';
                    box.style.display = 'block';
                    found.forEach(item => {
                        const div = document.createElement('div');
                        div.className = 'res-item';
                        div.innerText = item;
                        div.onclick = () => {
                            document.getElementById(id).value = item;
                            box.style.display='none';
                            vib('selection');
                            calcTotal(id.substring(0,3));
                        };
                        box.appendChild(div);
                    });
                } else {
                    box.style.display = 'none';
                }
            }
        }

        function modVal(id, delta, prefix) {
            vib('selection');
            const el = document.getElementById(id);
            let val = parseFloat(el.value) || 0;
            if(id.includes('Qty') && val + delta < 1) return;
            if(id.includes('Price') && val + delta < 0) val = 0;
            else val += delta;
            
            el.value = val;
            calcTotal(prefix);
            
            // Animation for input
            el.style.transform = "scale(1.1)";
            setTimeout(()=> el.style.transform = "scale(1)", 100);
        }

        function calcTotal(prefix) {
            const p = parseFloat(document.getElementById(prefix+'Price').value) || 0;
            const q = parseFloat(document.getElementById(prefix+'Qty').value) || 0;
            document.getElementById(prefix+'Total').innerText = (p*q).toLocaleString() + ' ‚ÇΩ';
        }

        function submitEntry(type) {
            const prefix = type === 'income' ? 'inc' : 'exp';
            const btn = document.getElementById(type === 'income' ? 'btnInc' : 'btnExp');
            
            const name = document.getElementById(prefix+'Name').value.trim();
            const price = parseFloat(document.getElementById(prefix+'Price').value);
            const qty = parseFloat(document.getElementById(prefix+'Qty').value);
            const total = price * qty;

            if(!name || !price) {
                vib('error');
                btn.classList.add('shake');
                setTimeout(()=> btn.classList.remove('shake'), 500);
                showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è", true);
                return;
            }

            // UI Optimistic Update
            vib('success');
            btn.disabled = true;
            btn.style.opacity = '0.7';

            const payload = { 
                action: 'saveTransaction', 
                type: type, 
                name: name, price: price, qty: qty, total: total, 
                isNew: !((type==='income'?config.incomeItems:config.expenseItems).includes(name)) 
            };
            
            // Add to cache list optimistically (simple append to top)
            const listEl = document.getElementById('list-'+type);
            const tempId = 'temp-'+Date.now();
            const fakeRow = { rowId: tempId, dateStr: new Date().toLocaleDateString(), name, price, qty, total };
            listEl.insertAdjacentHTML('afterbegin', renderCard(fakeRow, type, true));
            
            // Clear inputs
            document.getElementById(prefix+'Name').value = '';
            document.getElementById(prefix+'Price').value = '';
            document.getElementById(prefix+'Qty').value = 1;
            calcTotal(prefix);

            // Send
            fetch(GAS_URL, {
                method: "POST", body: JSON.stringify(payload)
            }).then(r => r.json()).then(res => {
                btn.disabled = false; btn.style.opacity = '1';
                if(res.success) {
                    showToast("–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ");
                    refreshTable(type, true); // Real refresh
                } else {
                    document.getElementById(tempId).remove();
                    showToast(res.message, true);
                }
            }).catch(e => {
                document.getElementById(tempId).remove();
                btn.disabled = false; btn.style.opacity = '1';
                showToast("–û—à–∏–±–∫–∞ —Å–µ—Ç–∏", true);
            });
        }

        // --- LISTS & TABLES ---
        function renderCard(row, type, isTemp=false) {
            const style = isTemp ? 'opacity:0.5;' : '';
            const btnColor = type === 'income' ? 'var(--color-inc)' : 'var(--color-exp)';
            return `
            <div class="card-item" id="${row.rowId}" style="${style}">
                <div class="card-row">
                    <span class="card-date">${row.dateStr}</span>
                    <span class="card-price" style="color:${btnColor}">${row.total.toLocaleString()}</span>
                </div>
                <div class="card-row">
                    <span class="card-title">${row.name}</span>
                    <div class="card-actions">
                        <button class="btn-icon btn-del" onclick="reqDelete('${row.rowId}', '${type}')">
                            <svg viewBox="0 0 24 24"><path d="M6 19c0 1.1.9 2 2 2h8c1.1 0 2-.9 2-2V7H6v12zM19 4h-3.5l-1-1h-5l-1 1H5v2h14V4z"/></svg>
                         </button>
                    </div>
                </div>
            </div>`;
        }

        function refreshTable(type, force=false) {
            if(!force && dataCache[type]) return;
            const list = document.getElementById('list-'+type);
            list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sub)">–ó–∞–≥—Ä—É–∑–∫–∞...</div>';
            
            fetch(GAS_URL, {
                method: "POST", body: JSON.stringify({ action: 'getTableData', type: type })
            }).then(r => r.json()).then(data => {
                dataCache[type] = data;
                if(!data.length) list.innerHTML = '<div style="text-align:center; padding:20px; color:var(--text-sub)">–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π</div>';
                else {
                    list.innerHTML = data.map(r => renderCard(r, type)).join('');
                }
            });
        }

        function reqDelete(id, type) {
            if(confirm("–£–¥–∞–ª–∏—Ç—å –∑–∞–ø–∏—Å—å?")) {
                vib('medium');
                document.getElementById(id).style.opacity = '0.2';
                fetch(GAS_URL, {
                     method: "POST", body: JSON.stringify({ action: 'deleteTransaction', rowId: id, type: type })
                }).then(r=>r.json()).then(res=>{
                    if(res.success) { showToast("–£–¥–∞–ª–µ–Ω–æ"); refreshTable(type, true); }
                });
            }
        }

        // --- ANALYTICS ---
        function loadAnalytics() {
            // Simple check to avoid spamming
            const kpi = document.getElementById('kpiInc');
            if(kpi.innerText !== '0') vib('light'); // Feedback on tab load

            fetch(GAS_URL, {
                 method: "POST", body: JSON.stringify({ action: 'getAnalyticsData', year: selYear, monthIdx: selMonth })
            }).then(r=>r.json()).then(d => {
                // Render KPI
                renderKpi('Inc', d.current.income, d.growth.income);
                renderKpi('Exp', d.current.expense, d.growth.expense);
                renderKpi('Prof', d.current.profit, d.growth.profit);
                renderKpi('Vis', d.current.visitors, d.growth.visitors);
                
                // Charts
                renderChart('chartPulse', d.pulse.labels, [
                    {label:'–î–æ—Ö–æ–¥', data:d.pulse.income, borderColor:'#34C759', backgroundColor:'rgba(52,199,89,0.1)', fill:true},
                    {label:'–†–∞—Å—Ö–æ–¥', data:d.pulse.expense, borderColor:'#FF3B30', backgroundColor:'rgba(255,59,48,0.1)', fill:true}
                ]);
                renderChart('chartAttendance', d.attendance.labels, [
                    {label:'–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏', data:d.attendance.data, borderColor:'#AF52DE', backgroundColor:'rgba(175,82,222,0.1)', fill:true}
                ]);
            });
        }

        function renderKpi(id, val, growth) {
            document.getElementById('kpi'+id).innerText = val.toLocaleString();
            const tr = document.getElementById('trend'+id);
            const isUp = growth >= 0;
            // Logic for expenses: growth is bad
            let isGood = isUp;
            if(id === 'Exp') isGood = !isUp;
            
            tr.className = `kpi-trend ${isGood ? 'trend-up' : 'trend-down'}`;
            tr.innerText = (isUp ? '‚Üó ' : '‚Üò ') + Math.abs(growth) + '%';
        }

        let chartInstances = {};
        function renderChart(id, labels, datasets) {
            const ctx = document.getElementById(id).getContext('2d');
            if(chartInstances[id]) chartInstances[id].destroy();
            
            chartInstances[id] = new Chart(ctx, {
                type: 'line',
                data: { labels, datasets },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    elements: { point: { radius: 0, hitRadius: 10 } },
                    scales: { x: { display: false }, y: { display: false } },
                    plugins: { legend: { display: false } },
                    interaction: { mode: 'index', intersect: false },
                }
            });
        }

        // --- 3D PICKER LOGIC ---
        let currentPickerType = null;
        function openPicker(type) {
            vib('medium');
            currentPickerType = type;
            const box = document.getElementById('wheelBox');
            box.innerHTML = ''; // clear
            
            // Add padding items for center alignment
            const padTop = document.createElement('div'); padTop.style.height = '80px'; box.appendChild(padTop);

            let items = [];
            if(type === 'year') items = availableYears.map(y => ({ val: y, txt: y }));
            else {
                items.push({val:'all', txt:'–í–µ—Å—å –≥–æ–¥'});
                monthNames.forEach((m,i) => items.push({val:i, txt:m}));
            }

            items.forEach(item => {
                const el = document.createElement('div');
                el.className = 'wheel-item';
                el.innerText = item.txt;
                el.dataset.val = item.val;
                
                // Highlight current
                if((type==='year' && item.val==selYear) || (type==='month' && item.val==selMonth)) {
                    el.style.opacity = '1';
                    el.style.fontWeight = '700';
                    el.style.transform = 'scale(1.1)';
                }
                
                box.appendChild(el);
            });

            const padBot = document.createElement('div'); padBot.style.height = '80px'; box.appendChild(padBot);
            
            document.getElementById('pickerModal').style.display = 'flex';
            
            // Scroll logic with Haptics
            let lastScroll = 0;
            box.onscroll = (e) => {
                const y = box.scrollTop;
                // Simple throttling for haptics
                if(Math.abs(y - lastScroll) > 30) {
                    vib('selection');
                    lastScroll = y;
                    updateWheelVisuals(box);
                }
            };
            // Scroll to current position
            setTimeout(() => {
                const active = Array.from(document.querySelectorAll('.wheel-item')).find(el => 
                    (type==='year' && el.dataset.val==selYear) || (type==='month' && el.dataset.val==selMonth)
                );
                if(active) active.scrollIntoView({block: "center"});
            }, 100);
        }

        function updateWheelVisuals(container) {
            const center = container.scrollTop + (container.clientHeight / 2);
            const items = container.querySelectorAll('.wheel-item');
            items.forEach(item => {
                const itemCenter = item.offsetTop + (item.clientHeight / 2);
                const dist = Math.abs(center - itemCenter);
                if(dist < 25) {
                    item.style.opacity = '1'; item.style.fontWeight = '700'; item.style.transform = 'scale(1.1)';
                } else {
                    item.style.opacity = '0.4'; item.style.fontWeight = '400'; item.style.transform = 'scale(1.0)';
                }
            });
        }

        function closePicker(save) {
            if(save) {
                vib('success');
                // Find centered item
                const box = document.getElementById('wheelBox');
                const center = box.scrollTop + (box.clientHeight / 2);
                let selected = null;
                let minDist = 9999;
                
                box.querySelectorAll('.wheel-item').forEach(item => {
                    const d = Math.abs((item.offsetTop + item.clientHeight/2) - center);
                    if(d < minDist) { minDist = d; selected = item; }
                });

                if(selected) {
                    const val = selected.dataset.val;
                    if(currentPickerType === 'year') {
                        selYear = parseInt(val);
                        document.getElementById('txtYear').innerText = selYear;
                    } else {
                        selMonth = val === 'all' ? 'all' : parseInt(val);
                        document.getElementById('txtMonth').innerText = val === 'all' ? '–í–µ—Å—å –≥–æ–¥' : monthNames[val];
                    }
                    loadAnalytics();
                }
            } else {
                vib('light');
            }
            document.getElementById('pickerModal').style.display = 'none';
        }

        // --- UTILS ---
        function setupScrollHaptics() {
            // Attach to scrollable areas
            const areas = document.querySelectorAll('.tab-page, .wheel-container');
            areas.forEach(area => {
                let lastY = 0;
                area.addEventListener('scroll', () => {
                    const nowY = area.scrollTop;
                    if(Math.abs(nowY - lastY) > 50) { // Every 50px
                        vib('selection');
                        lastY = nowY;
                    }
                }, {passive: true});
            });
        }

        function fetchInitialConfig() {
            fetch(GAS_URL, { method: "POST", body: JSON.stringify({ action: 'getInitialConfig' }) })
            .then(r=>r.json()).then(res => {
                config = res;
                availableYears = res.years;
                document.getElementById('txtYear').innerText = selYear;
                document.getElementById('txtMonth').innerText = monthNames[selMonth];
            });
        }
        
        function toggleTheme() {
            vib('medium');
            const body = document.body;
            const cur = body.getAttribute('data-theme');
            const next = cur === 'dark' ? 'light' : 'dark';
            body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        function showToast(msg, isErr) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.className = isErr ? 'toast error show' : 'toast show';
            if(isErr) vib('error');
            setTimeout(() => t.className = 'toast', 2500);
        }
    </script>
</body>
</html>
