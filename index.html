<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>–í–µ–Ω–µ—Ä–∞ App</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root { 
        --bg-app: #F2F2F7;         /* –§–æ–Ω –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è (—Å–µ—Ä—ã–π iOS) */
        --bg-panel: #FFFFFF;       /* –§–æ–Ω –∫–∞—Ä—Ç–æ—á–µ–∫ */
        --text-main: #000000;
        --text-sub: #8E8E93;
        --accent: #007AFF;         /* iOS Blue */
        --border: rgba(0,0,0,0.1); 
        --input-bg: #F2F2F7;
        
        --color-inc: #34C759;      /* iOS Green */
        --color-exp: #FF3B30;      /* iOS Red */
        --color-prof: #5856D6;     /* iOS Indigo */
        --color-vis: #AF52DE;      /* iOS Purple */
        
        --nav-height-pc: 70px;
        --nav-height-mobile: 85px; /* –° —É—á–µ—Ç–æ–º safe-area */
        --radius: 18px;
      }
      
      [data-theme="dark"] { 
        --bg-app: #000000;
        --bg-panel: #1C1C1E; 
        --text-main: #FFFFFF;     
        --text-sub: #98989D;      
        --accent: #0A84FF;        
        --border: #38383A;        
        --input-bg: #2C2C2E;      
      }
      
      /* --- –û–°–ù–û–í–ù–û–ô –ö–ê–†–ö–ê–° --- */
      body { 
          margin: 0;
          padding: 0;
          font-family: 'Inter', -apple-system, sans-serif; 
          background-color: var(--bg-app); 
          color: var(--text-main); 
          height: 100vh; /* –§–æ–ª–ª–±–µ–∫ */
          height: 100dvh; /* –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è –º–æ–±–∏–ª–æ–∫ */
          overflow: hidden; /* –ó–∞–ø—Ä–µ—â–∞–µ–º —Å–∫—Ä–æ–ª–ª –≤—Å–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è */
          display: flex;
          flex-direction: column;
          -webkit-user-select: none; /* –ö–∞–∫ –≤ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–∏, —Ç–µ–∫—Å—Ç –Ω–µ –≤—ã–¥–µ–ª—è–µ—Ç—Å—è —Å–ª—É—á–∞–π–Ω–æ */
          user-select: none;
      }

      /* --- –®–ê–ü–ö–ê (HEADER) --- */
      .header {
          height: var(--nav-height-pc);
          background: var(--bg-panel);
          border-bottom: 1px solid var(--border);
          display: flex;
          align-items: center;
          padding: 0 20px;
          gap: 30px;
          flex-shrink: 0;
          z-index: 100;
      }

      .brand-box {
          display: flex;
          align-items: center;
          gap: 12px;
          cursor: pointer; /* –ö–ª–∏–∫–∞–±–µ–ª—å–Ω–æ –¥–ª—è —Å–º–µ–Ω—ã —Ç–µ–º—ã */
          transition: opacity 0.2s;
      }
      .brand-box:active { opacity: 0.7; }
      
      .venus-icon { 
          width: 38px; 
          height: 38px; 
          transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      }
      /* –ö–ª–∞—Å—Å –¥–ª—è –∞–Ω–∏–º–∞—Ü–∏–∏ –≤—Ä–∞—â–µ–Ω–∏—è –ø—Ä–∏ —Å–º–µ–Ω–µ —Ç–µ–º—ã */
      .rotate-anim { transform: rotate(180deg) scale(1.1); }

      .title { font-size: 20px; font-weight: 800; letter-spacing: -0.5px; }

      /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø (–ü–ö –í–ï–†–°–ò–Ø - –°–≤–µ—Ä—Ö—É –°–ª–µ–≤–∞) --- */
      .nav-pc {
          display: flex;
          gap: 10px;
      }
      .nav-btn-pc {
          background: transparent;
          border: none;
          padding: 8px 16px;
          border-radius: 10px;
          color: var(--text-sub);
          font-weight: 600;
          cursor: pointer;
          transition: 0.2s;
          font-size: 14px;
      }
      .nav-btn-pc:hover { background: var(--bg-app); color: var(--text-main); }
      .nav-btn-pc.active { background: var(--input-bg); color: var(--accent); }

      /* --- –ö–û–ù–¢–ï–ù–¢–ù–ê–Ø –û–ë–õ–ê–°–¢–¨ --- */
      .content-area {
          flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—ë –æ—Å—Ç–∞–≤—à–µ–µ—Å—è –º–µ—Å—Ç–æ */
          position: relative;
          overflow: hidden; /* –°–∫—Ä–æ–ª–ª–∏—Ç—Å—è —Ç–æ–ª—å–∫–æ –≤–Ω—É—Ç—Ä–∏ –ø–∞–Ω–µ–ª–µ–π */
          padding: 20px;
          max-width: 1400px;
          width: 100%;
          margin: 0 auto;
          box-sizing: border-box;
      }

      .tab-page { 
          display: none; 
          height: 100%; 
          flex-direction: column;
      }
      .tab-page.active { display: flex; animation: fadeScale 0.3s ease; }
      @keyframes fadeScale { from { opacity: 0; transform: scale(0.98); } to { opacity: 1; transform: scale(1); } }

      /* –†–ê–ó–î–ï–õ–ï–ù–ò–ï –≠–ö–†–ê–ù–ê (–ü–ö) */
      .split-view {
          display: flex;
          gap: 20px;
          height: 100%;
          overflow: hidden;
      }

      /* –ü–∞–Ω–µ–ª–∏ */
      .panel {
          background: var(--bg-panel);
          border-radius: var(--radius);
          box-shadow: 0 4px 24px rgba(0,0,0,0.04);
          border: 1px solid var(--border);
          display: flex;
          flex-direction: column;
          overflow: hidden;
      }

      /* –õ–ï–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–í–≤–æ–¥) */
      .panel-left {
          width: 340px;
          flex-shrink: 0;
          padding: 24px;
          overflow-y: auto; /* –°–∫—Ä–æ–ª–ª –µ—Å–ª–∏ —Ñ–æ—Ä–º–∞ –¥–ª–∏–Ω–Ω–∞—è */
      }

      /* –ü–†–ê–í–ê–Ø –ü–ê–ù–ï–õ–¨ (–ò—Å—Ç–æ—Ä–∏—è) */
      .panel-right {
          flex: 1;
          display: flex;
          flex-direction: column;
          min-width: 0; /* –í–∞–∂–Ω–æ –¥–ª—è flex –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ */
      }

      .table-header {
          padding: 20px 24px;
          border-bottom: 1px solid var(--border);
          display: flex;
          justify-content: space-between;
          align-items: center;
          flex-shrink: 0;
      }

      /* üî• –¢–ê–ë–õ–ò–¶–ê –° –ì–û–†–ò–ó–û–ù–¢–ê–õ–¨–ù–´–ú –°–ö–†–û–õ–õ–û–ú üî• */
      .grid-wrapper {
          flex: 1; /* –ó–∞–Ω–∏–º–∞–µ—Ç –≤—Å—é –≤—ã—Å–æ—Ç—É */
          overflow: auto; /* –°–∫—Ä–æ–ª–ª –≤–æ –≤—Å–µ —Å—Ç–æ—Ä–æ–Ω—ã –ø—Ä–∏ –Ω–µ–æ–±—Ö–æ–¥–∏–º–æ—Å—Ç–∏ */
          -webkit-overflow-scrolling: touch;
      }
      
      table {
          width: 100%;
          border-collapse: collapse;
          /* –ù–µ –¥–∞–µ–º —Ç–∞–±–ª–∏—Ü–µ —Å–∂–∏–º–∞—Ç—å—Å—è –º–µ–Ω—å—à–µ –∫–æ–Ω—Ç–µ–Ω—Ç–∞ -> –≤—ã–∑—ã–≤–∞–µ—Ç –≥–æ—Ä–∏–∑. —Å–∫—Ä–æ–ª–ª */
          min-width: 500px; 
      }
      
      th {
          position: sticky; top: 0; z-index: 10;
          background: var(--bg-panel);
          text-align: left;
          padding: 12px 24px;
          font-size: 11px;
          text-transform: uppercase;
          color: var(--text-sub);
          border-bottom: 1px solid var(--border);
      }
      
      td {
          padding: 16px 24px;
          border-bottom: 1px solid var(--border);
          font-size: 14px;
          white-space: nowrap; /* –¢–µ–∫—Å—Ç –Ω–µ –ø–µ—Ä–µ–Ω–æ—Å–∏—Ç—Å—è, —Ä–∞—Å—à–∏—Ä—è–µ—Ç —Ç–∞–±–ª–∏—Ü—É */
      }
      tr:last-child td { border-bottom: none; }

      /* –≠–õ–ï–ú–ï–ù–¢–´ –£–ü–†–ê–í–õ–ï–ù–ò–Ø */
      input {
          width: 100%; padding: 14px; margin-bottom: 15px;
          background: var(--input-bg); border: none; border-radius: 12px;
          color: var(--text-main); font-size: 16px; outline: none;
          box-sizing: border-box;
      }
      input:focus { box-shadow: 0 0 0 2px var(--accent) inset; }
      
      label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; }

      .qty-box {
          display: flex; align-items: center; gap: 8px; margin-bottom: 15px;
          background: var(--input-bg); padding: 4px; border-radius: 12px;
      }
      .qty-btn {
          width: 36px; height: 36px; border-radius: 8px; background: var(--bg-panel);
          border: 0.5px solid rgba(0,0,0,0.1); color: var(--text-main); font-size: 18px;
          display: flex; align-items: center; justify-content: center; cursor: pointer;
      }
      .qty-btn:active { transform: scale(0.9); }
      .qty-val { flex: 1; text-align: center; font-weight: 700; border: none; background: transparent; padding: 0; margin: 0; }

      .btn-main {
          width: 100%; padding: 16px; background: var(--accent);
          color: white; border: none; border-radius: 14px;
          font-size: 16px; font-weight: 600; cursor: pointer;
          margin-top: 10px;
      }
      .btn-main:active { opacity: 0.8; transform: scale(0.98); }

      /* --- –ú–û–ë–ò–õ–¨–ù–ê–Ø –ù–ê–í–ò–ì–ê–¶–ò–Ø (–ù–ò–ñ–ù–Ø–Ø) --- */
      .nav-mobile {
          display: none; /* –°–∫—Ä—ã—Ç–æ –Ω–∞ –ü–ö */
      }

      /* --- –ê–î–ê–ü–¢–ê–¶–ò–Ø –ü–û–î –ú–û–ë–ò–õ–¨–ù–´–ï --- */
      @media (max-width: 900px) {
          /* –£–±–∏—Ä–∞–µ–º –ü–ö –Ω–∞–≤–∏–≥–∞—Ü–∏—é */
          .nav-pc { display: none; }
          
          /* –•–µ–¥–µ—Ä –º–µ–Ω—å—à–µ */
          .header { height: 50px; justify-content: center; padding: 0; }
          /* –¶–µ–Ω—Ç—Ä—É–µ–º –ª–æ–≥–æ—Ç–∏–ø –Ω–∞ –º–æ–±–∏–ª–∫–µ */
          .brand-box { margin: 0; }
          .title { font-size: 17px; }

          /* –ö–æ–Ω—Ç–µ–Ω—Ç */
          .content-area {
              padding: 15px;
              padding-bottom: 0; /* –û—Ç—Å—Ç—É–ø —Å–¥–µ–ª–∞–µ–º –≤–Ω—É—Ç—Ä–∏ split-view */
          }

          /* –í–µ—Ä—Ç–∏–∫–∞–ª—å–Ω—ã–π —Å—Ç–µ–∫ */
          .split-view {
              flex-direction: column;
              height: auto;
              overflow: visible;
              padding-bottom: var(--nav-height-mobile); /* –ú–µ—Å—Ç–æ –¥–ª—è –º–µ–Ω—é */
          }

          /* –ü–∞–Ω–µ–ª–∏ */
          .panel-left { width: 100%; height: auto; border-radius: 20px; overflow: visible; }
          .panel-right { 
              height: 400px; /* –§–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–∞—è –≤—ã—Å–æ—Ç–∞ –¥–ª—è —Å–ø–∏—Å–∫–∞, —á—Ç–æ–±—ã –Ω–µ —Ä–æ—Å –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ */
              flex: none; 
              border-radius: 20px; 
          }
          
          /* üî• –ù–ò–ñ–ù–ï–ï –ú–ï–ù–Æ (iPhone Style) üî• */
          .nav-mobile {
              display: flex;
              position: fixed;
              bottom: 0; left: 0; width: 100%;
              height: var(--nav-height-mobile);
              background: rgba(255,255,255,0.85);
              backdrop-filter: blur(20px);
              -webkit-backdrop-filter: blur(20px);
              border-top: 0.5px solid rgba(0,0,0,0.1);
              z-index: 1000;
              justify-content: space-around;
              padding-top: 10px;
              padding-bottom: env(safe-area-inset-bottom);
              box-sizing: border-box;
          }
          [data-theme="dark"] .nav-mobile { background: rgba(28,28,30,0.85); border-top-color: rgba(255,255,255,0.1); }

          .nav-item {
              display: flex;
              flex-direction: column;
              align-items: center;
              justify-content: flex-start;
              gap: 4px;
              width: 33%;
              border: none;
              background: transparent;
              color: var(--text-sub);
              cursor: pointer;
          }
          
          .nav-icon-box {
              width: 28px; height: 28px;
              display: flex; align-items: center; justify-content: center;
              transition: 0.2s;
          }
          .nav-item svg { width: 24px; height: 24px; fill: currentColor; }
          .nav-label { font-size: 10px; font-weight: 500; }

          .nav-item.active { color: var(--accent); }
          .nav-item.active .nav-icon-box { transform: translateY(-2px); }
          
          /* –°–µ—Ç–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏ –≤ 2 –∫–æ–ª–æ–Ω–∫–∏ */
          .kpi-grid { grid-template-columns: 1fr 1fr; }
          .charts-grid { grid-template-columns: 1fr; }
      }

      /* –£–¢–ò–õ–ò–¢–´ */
      #accessDenied { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-app); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px; }
      .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.05); z-index: 1500; display: none; }
      .toast { position: fixed; top: 20px; left: 50%; transform: translateX(-50%); background: var(--bg-panel); color: var(--text-main); padding: 12px 24px; border-radius: 50px; box-shadow: 0 10px 40px rgba(0,0,0,0.2); font-weight: 600; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; display: flex; align-items: center; gap: 8px; }
      .toast.show { opacity: 1; top: 40px; }
    </style>
</head>
<body data-theme="light">

    <div id="loader" class="loader"></div>
    <div id="toast" class="toast">‚úÖ <span>–ì–æ—Ç–æ–≤–æ</span></div>

    <div id="accessDenied" style="display: none;">
        <h1>üîí</h1>
        <h3>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h3>
        <p>–í–∞—à ID –Ω–µ –Ω–∞–π–¥–µ–Ω</p>
    </div>

    <div class="header">
        <div class="brand-box" onclick="toggleTheme()" title="–ù–∞–∂–º–∏, —á—Ç–æ–±—ã —Å–º–µ–Ω–∏—Ç—å —Ç–µ–º—É">
            <svg class="venus-icon" id="planetIcon" viewBox="0 0 100 100">
                <defs>
                    <linearGradient id="grad1" x1="0%" y1="0%" x2="100%" y2="100%">
                        <stop offset="0%" style="stop-color:#FFD700;stop-opacity:1" />
                        <stop offset="100%" style="stop-color:#FF8C00;stop-opacity:1" />
                    </linearGradient>
                </defs>
                <circle cx="50" cy="50" r="45" fill="url(#grad1)" />
                <path d="M10 50 Q 50 35 90 50" stroke="rgba(255,255,255,0.4)" stroke-width="3" fill="none"/>
                <circle cx="70" cy="35" r="5" fill="rgba(255,255,255,0.2)"/>
            </svg>
            <span class="title">–í–µ–Ω–µ—Ä–∞</span>
        </div>

        <nav class="nav-pc">
            <button class="nav-btn-pc active" onclick="switchTab('income')">–ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã</button>
            <button class="nav-btn-pc" onclick="switchTab('expense')">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</button>
            <button class="nav-btn-pc" onclick="switchTab('analytics')">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</button>
        </nav>
    </div>

    <div class="content-area">
        
        <div id="splitTab" class="tab-page active">
            <div class="split-view">
                
                <div class="panel panel-left">
                    <h3 id="formTitle" style="margin-top:0">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3>
                    
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <div style="position:relative;">
                        <input type="text" id="inpName" placeholder="–ü–æ–∏—Å–∫..." oninput="showSearch(event); calcTotal()" autocomplete="off">
                        <div id="searchRes" style="position:absolute; top:50px; left:0; width:100%; background:var(--bg-panel); border:1px solid var(--border); border-radius:12px; z-index:20; display:none; max-height:200px; overflow-y:auto; box-shadow:0 10px 30px rgba(0,0,0,0.1);"></div>
                    </div>

                    <div style="display:flex; gap:12px;">
                        <div style="flex:1">
                            <label>–¶–µ–Ω–∞</label>
                            <input type="number" id="inpPrice" placeholder="0" oninput="calcTotal()">
                        </div>
                        <div style="flex:1">
                            <label>–ö–æ–ª-–≤–æ</label>
                            <div class="qty-box">
                                <button class="qty-btn" onclick="modVal('inpQty', -1)">‚àí</button>
                                <input type="number" id="inpQty" class="qty-val" value="1" oninput="calcTotal()">
                                <button class="qty-btn" onclick="modVal('inpQty', 1)">+</button>
                            </div>
                        </div>
                    </div>

                    <div style="padding:15px; background:var(--input-bg); border-radius:14px; display:flex; justify-content:space-between; align-items:center; margin-top:10px;">
                        <span style="font-size:13px; font-weight:600; color:var(--text-sub)">–ò–¢–û–ì–û</span>
                        <span id="txtTotal" style="font-size:20px; font-weight:800; color:var(--text-main)">0 ‚ÇΩ</span>
                    </div>

                    <button class="btn-main" onclick="submitEntry()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>

                <div class="panel panel-right">
                    <div class="table-header">
                        <h3 id="tableTitle" style="margin:0; font-size:16px;">–ò—Å—Ç–æ—Ä–∏—è</h3>
                        <button onclick="refreshTable(true)" style="border:none; background:none; color:var(--accent); font-weight:600; cursor:pointer;">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                    <div class="grid-wrapper">
                        <table id="mainTable">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th style="text-align:right">–°—É–º–º–∞</th>
                                    <th style="text-align:right">...</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                        <div id="emptyMsg" style="padding:30px; text-align:center; color:var(--text-sub);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>

            </div>
        </div>

        <div id="analyticsTab" class="tab-page">
            <div style="display:flex; gap:10px; margin-bottom:20px; overflow-x:auto;">
                <select id="anYear" onchange="loadAnalytics()" style="margin:0; width:auto; flex:1;"></select>
                <select id="anMonth" onchange="loadAnalytics()" style="margin:0; width:auto; flex:1;"></select>
            </div>

            <div style="display:grid; grid-template-columns: repeat(auto-fit, minmax(140px, 1fr)); gap:15px; margin-bottom:20px;">
                <div class="panel" style="padding:15px;">
                    <div style="font-size:11px; font-weight:700; color:var(--text-sub); text-transform:uppercase;">–î–æ—Ö–æ–¥</div>
                    <div id="kpiInc" style="font-size:22px; font-weight:800; color:var(--color-inc); margin-top:4px;">0</div>
                </div>
                <div class="panel" style="padding:15px;">
                    <div style="font-size:11px; font-weight:700; color:var(--text-sub); text-transform:uppercase;">–†–∞—Å—Ö–æ–¥</div>
                    <div id="kpiExp" style="font-size:22px; font-weight:800; color:var(--color-exp); margin-top:4px;">0</div>
                </div>
                <div class="panel" style="padding:15px;">
                    <div style="font-size:11px; font-weight:700; color:var(--text-sub); text-transform:uppercase;">–ü—Ä–∏–±—ã–ª—å</div>
                    <div id="kpiProf" style="font-size:22px; font-weight:800; color:var(--color-prof); margin-top:4px;">0</div>
                </div>
            </div>

            <div class="panel" style="padding:20px; min-height:300px; margin-bottom:20px;">
                 <h3 style="margin-top:0">–§–∏–Ω–∞–Ω—Å—ã</h3>
                 <div style="flex:1; position:relative;"><canvas id="chartPulse"></canvas></div>
            </div>
             <div class="panel" style="padding:20px; min-height:300px; margin-bottom:100px;">
                 <h3 style="margin-top:0">–ü–æ—Å–µ—â–∞–µ–º–æ—Å—Ç—å</h3>
                 <div style="flex:1; position:relative;"><canvas id="chartAttendance"></canvas></div>
            </div>
        </div>

    </div>

    <div class="nav-mobile">
        <button class="nav-item active" onclick="switchTab('income')">
            <div class="nav-icon-box">
                <svg viewBox="0 0 24 24"><path d="M12 2L2 7l10 5 10-5-10-5zm0 9l2.5-1.25L12 8.5l-2.5 1.25L12 11zm0 2.5l-5-2.5-5 2.5L12 22l10-8.5-5-2.5-5 2.5z"/></svg>
            </div>
            <span class="nav-label">–ú–ö</span>
        </button>
        <button class="nav-item" onclick="switchTab('expense')">
            <div class="nav-icon-box">
                 <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zm-7 3c1.66 0 3 1.34 3 3s-1.34 3-3 3-3-1.34-3-3 1.34-3 3-3zm6 12H6v-1c0-2 4-3.1 6-3.1s6 1.1 6 3.1v1z"/></svg>
            </div>
            <span class="nav-label">–†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏</span>
        </button>
        <button class="nav-item" onclick="switchTab('analytics')">
            <div class="nav-icon-box">
                <svg viewBox="0 0 24 24"><path d="M3 3v18h18v-2H5V3H3zm4 14h2v-7H7v7zm4 0h2v-10h-2v10zm4 0h2v-4h-2v4z"/></svg>
            </div>
            <span class="nav-label">–ê–Ω–∞–ª–∏—Ç–∏–∫–∞</span>
        </button>
    </div>

    <script>
        // --- CONFIG ---
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyDN6u9RdE9wD0bO4XetH2fmgD-I5XJQo_MhhyIvLGHg3Ub_NCLTUVdjkfAPkNrbF17/exec';
        const ALLOWED_USERS = [1271410534, 1248292955]; 

        let currTab = 'income';
        let dataCache = { income: null, expense: null };
        let config = { incomeItems: [], expenseItems: [] };
        let charts = {};

        // --- INIT ---
        window.onload = function() {
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand();
                // –ö—Ä–∞—Å–∏–º —Ö–µ–¥–µ—Ä —Ç–µ–ª–µ–≥—Ä–∞–º–∞ –≤ —Ü–≤–µ—Ç –Ω–∞—à–µ–≥–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏—è
                window.Telegram.WebApp.setHeaderColor(document.body.getAttribute('data-theme') === 'dark' ? '#1C1C1E' : '#FFFFFF');
            }

            if (!checkAccess()) return;

            toggleLoader(true);
            runBackend('getInitialConfig').then(res => {
                config = res;
                setupDateSelects(res);
                refreshTable(true);
                toggleLoader(false);
            }).catch(e => {
                showToast("–û—à–∏–±–∫–∞: " + e);
                toggleLoader(false);
            });
            
            // –í–æ—Å—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–µ–º—É
            if (localStorage.getItem('theme') === 'dark') applyTheme('dark');
        };

        function setupDateSelects(res) {
            const ySel = document.getElementById('anYear'), mSel = document.getElementById('anMonth');
            ySel.innerHTML=''; res.years.forEach(y => ySel.add(new Option(y, y)));
            mSel.innerHTML=''; mSel.add(new Option('–í–µ—Å—å –≥–æ–¥', 'all')); 
            res.months.forEach((m,i) => mSel.add(new Option(m, i))); 
            mSel.value = new Date().getMonth();
        }

        // --- LOGIC ---
        function switchTab(tab) {
            currTab = tab;
            
            // –û–±–Ω–æ–≤–ª—è–µ–º –∫–Ω–æ–ø–∫–∏ (–ü–ö –∏ –ú–æ–±)
            document.querySelectorAll('.nav-btn-pc, .nav-item').forEach(b => b.classList.remove('active'));
            
            // –ò—â–µ–º –∫–Ω–æ–ø–∫–∏ –ø–æ onclick –∞—Ç—Ä–∏–±—É—Ç—É (–ø—Ä–æ—Å—Ç–æ–π —Ö–∞–∫)
            const selectors = `[onclick="switchTab('${tab}')"]`;
            document.querySelectorAll(selectors).forEach(el => el.classList.add('active'));

            // –ü–µ—Ä–µ–∫–ª—é—á–∞–µ–º —Ç–∞–±—ã
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            if (tab === 'analytics') {
                document.getElementById('analyticsTab').classList.add('active');
                loadAnalytics();
            } else {
                document.getElementById('splitTab').classList.add('active');
                updateUI();
                if (!dataCache[tab]) refreshTable(true);
                else renderTable(dataCache[tab]);
            }
        }

        function updateUI() {
            const isInc = currTab === 'income';
            document.getElementById('formTitle').innerText = isInc ? '–î–æ–±–∞–≤–∏—Ç—å –ú–ö' : '–î–æ–±–∞–≤–∏—Ç—å –†–∞—Å—Ö–æ–¥';
            document.getElementById('tableTitle').innerText = isInc ? '–ò—Å—Ç–æ—Ä–∏—è (–î–æ—Ö–æ–¥)' : '–ò—Å—Ç–æ—Ä–∏—è (–†–∞—Å—Ö–æ–¥)';
            document.getElementById('inpName').value = '';
            document.getElementById('inpPrice').value = '';
            document.getElementById('inpQty').value = 1;
            calcTotal();
        }

        function toggleTheme() {
            const current = document.body.getAttribute('data-theme');
            const next = current === 'dark' ? 'light' : 'dark';
            applyTheme(next);
            
            // –ê–Ω–∏–º–∞—Ü–∏—è –ø–ª–∞–Ω–µ—Ç
            const icon = document.getElementById('planetIcon');
            icon.classList.add('rotate-anim');
            setTimeout(() => icon.classList.remove('rotate-anim'), 500);
        }

        function applyTheme(theme) {
            document.body.setAttribute('data-theme', theme);
            localStorage.setItem('theme', theme);
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.setHeaderColor(theme === 'dark' ? '#1C1C1E' : '#FFFFFF');
                window.Telegram.WebApp.setBackgroundColor(theme === 'dark' ? '#000000' : '#F2F2F7');
            }
            // –ü–µ—Ä–µ—Ä–∏—Å–æ–≤–∞—Ç—å –≥—Ä–∞—Ñ–∏–∫–∏ –µ—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∞
            if (currTab === 'analytics') loadAnalytics(); 
        }

        // --- DATA ---
        async function runBackend(action, payload = {}) {
            if (typeof google !== 'undefined' && google.script) {
                return new Promise((res, rej) => {
                    if (action === 'getInitialConfig') google.script.run.withSuccessHandler(res).withFailureHandler(rej).getInitialConfig();
                    else if (action === 'saveTransaction') google.script.run.withSuccessHandler(res).withFailureHandler(rej).saveTransaction(payload);
                    else if (action === 'getTableData') google.script.run.withSuccessHandler(res).withFailureHandler(rej).getTableData(payload.type);
                    else if (action === 'getAnalyticsData') google.script.run.withSuccessHandler(res).withFailureHandler(rej).getAnalyticsData(payload.year, payload.monthIdx);
                });
            } else {
                // PC Fetch fallback
                payload.action = action;
                const r = await fetch(GAS_URL, { method: 'POST', body: JSON.stringify(payload) });
                return await r.json();
            }
        }

        function submitEntry() {
            const name = document.getElementById('inpName').value;
            const price = document.getElementById('inpPrice').value;
            const qty = document.getElementById('inpQty').value;
            if(!name || !price) { showToast('–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è'); return; }

            toggleLoader(true);
            const payload = { type: currTab, name, price: parseFloat(price), qty: parseFloat(qty), total: parseFloat(price)*parseFloat(qty), isNew: true };
            
            runBackend('saveTransaction', payload).then(res => {
                toggleLoader(false);
                if(res.success) { showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); refreshTable(true); updateUI(); }
                else showToast('–û—à–∏–±–∫–∞');
            });
        }

        function refreshTable(force) {
            const tbody = document.getElementById('tableBody');
            if(force) {
                tbody.innerHTML = '';
                document.getElementById('emptyMsg').style.display='block';
                runBackend('getTableData', {type: currTab}).then(data => {
                    dataCache[currTab] = data;
                    renderTable(data);
                });
            } else renderTable(dataCache[currTab]);
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            const msg = document.getElementById('emptyMsg');
            tbody.innerHTML = '';
            
            if(!data || !data.length) { msg.style.display='block'; return; }
            msg.style.display='none';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="color:var(--text-sub)">${row.dateStr.slice(0,5)}</td>
                    <td style="font-weight:600">${row.name}</td>
                    <td style="text-align:right; font-weight:700">${row.total}</td>
                    <td style="text-align:right; color:var(--text-sub); font-size:10px;">ID ${row.rowId}</td>
                `;
                tbody.appendChild(tr);
            });
        }
        
        // --- ANALYTICS STUB ---
        function loadAnalytics() {
            const y = document.getElementById('anYear').value;
            const m = document.getElementById('anMonth').value;
            runBackend('getAnalyticsData', {year: y, monthIdx: m}).then(d => {
                document.getElementById('kpiInc').innerText = d.current.income.toLocaleString();
                document.getElementById('kpiExp').innerText = d.current.expense.toLocaleString();
                document.getElementById('kpiProf').innerText = d.current.profit.toLocaleString();
                renderChart('chartPulse', d.pulse.labels, d.pulse.income, d.pulse.expense);
                renderChart('chartAttendance', d.attendance.labels, d.attendance.data, null);
            });
        }
        
        function renderChart(id, lbls, d1, d2) {
             const ctx = document.getElementById(id).getContext('2d');
             if(charts[id]) charts[id].destroy();
             const isDark = document.body.getAttribute('data-theme') === 'dark';
             const colorText = isDark ? '#8E8E93' : '#8E8E93';
             
             charts[id] = new Chart(ctx, {
                 type: 'line',
                 data: {
                     labels: lbls,
                     datasets: [
                         { label: '1', data: d1, borderColor: '#34C759', backgroundColor: 'rgba(52, 199, 89, 0.1)', fill: true, tension: 0.4, pointRadius: 0 },
                         d2 ? { label: '2', data: d2, borderColor: '#FF3B30', backgroundColor: 'rgba(255, 59, 48, 0.1)', fill: true, tension: 0.4, pointRadius: 0 } : {}
                     ]
                 },
                 options: {
                     responsive: true, maintainAspectRatio: false,
                     plugins: { legend: {display:false} },
                     scales: {
                         x: { grid: {display:false}, ticks: {color: colorText, font:{size:9}} },
                         y: { display:false }
                     }
                 }
             });
        }

        // --- UTILS ---
        function checkAccess() {
            if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe?.user) return true;
            const user = window.Telegram.WebApp.initDataUnsafe.user;
            if (!ALLOWED_USERS.includes(user.id)) {
                document.getElementById('accessDenied').style.display='flex';
                document.querySelector('.header').style.display='none';
                document.querySelector('.content-area').style.display='none';
                document.querySelector('.nav-mobile').style.display='none';
                return false;
            }
            return true;
        }
        function showSearch(e) {
            const val = e.target.value.toLowerCase();
            const box = document.getElementById('searchRes');
            box.innerHTML = '';
            if(!val) { box.style.display='none'; return; }
            
            const list = currTab === 'income' ? config.incomeItems : config.expenseItems;
            const filtered = list.filter(i => i.toLowerCase().includes(val)).slice(0,5);
            
            if(filtered.length) {
                box.style.display='block';
                filtered.forEach(item => {
                    const d = document.createElement('div');
                    d.style.padding='12px'; d.style.borderBottom='1px solid var(--border)';
                    d.innerText = item;
                    d.onclick = () => { document.getElementById('inpName').value=item; box.style.display='none'; };
                    box.appendChild(d);
                });
            } else box.style.display='none';
        }
        function calcTotal() {
            const p = parseFloat(document.getElementById('inpPrice').value)||0;
            const q = parseFloat(document.getElementById('inpQty').value)||0;
            document.getElementById('txtTotal').innerText = (p*q).toLocaleString() + ' ‚ÇΩ';
        }
        function modVal(id, d) {
            const el = document.getElementById(id);
            let v = parseFloat(el.value)||0; v+=d; if(v<1)v=1; el.value=v; calcTotal();
        }
        function toggleLoader(s) { document.getElementById('loader').style.display = s ? 'block' : 'none'; }
        function showToast(m) {
            const t = document.getElementById('toast');
            t.innerHTML = m; t.classList.add('show');
            setTimeout(()=>t.classList.remove('show'), 2000);
        }
    </script>
</body>
</html>
