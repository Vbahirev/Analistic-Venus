<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Venus Workshop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
      :root { 
        --bg-app: #F2F2F7;
        --bg-panel: linear-gradient(180deg, #FFFFFF 0%, #F5F7FA 100%);      
        --text-main: #1C1C1E;     
        --text-sub: #8E8E93;      
        --accent: #007AFF;        
        --border: rgba(0,0,0,0.08); 
        --border-strong: #C7C7CC;
        --input-bg: #FFFFFF;      
        --danger: #FF3B30;
        --shadow-card: 0 4px 12px rgba(0,0,0,0.06);
        --radius: 20px;
        --scroll-thumb: #C7C7CC;
      }
      [data-theme="dark"] { 
        --bg-app: #0f172a;
        --bg-panel: #1e293b; 
        --text-main: #f8fafc;     
        --text-sub: #94a3b8;      
        --accent: #60a5fa;        
        --border: #334155;        
        --border-strong: #475569;
        --input-bg: #0f172a;      
        --shadow-card: 0 4px 20px rgba(0,0,0,0.4);
        --scroll-thumb: #475569;
      }

      * { -webkit-tap-highlight-color: transparent; }
      ::-webkit-scrollbar { width: 6px; height: 6px; }
      ::-webkit-scrollbar-track { background: transparent; }
      ::-webkit-scrollbar-thumb { background-color: var(--scroll-thumb); border-radius: 10px; }
      body { 
          margin: 0; padding: 20px; 
          font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; 
          background-color: var(--bg-app); 
          color: var(--text-main); 
          height: 100vh; height: 100dvh; 
          box-sizing: border-box; 
          overflow: hidden; 
          display:flex; flex-direction:column;
          -webkit-font-smoothing: antialiased;
          font-weight: 500;
      }

      /* NEW: shake animation for invalid add button */
      @keyframes shakeX {
        0% { transform: translateX(0); }
        20% { transform: translateX(-8px); }
        40% { transform: translateX(8px); }
        60% { transform: translateX(-6px); }
        80% { transform: translateX(6px); }
        100% { transform: translateX(0); }
      }
      .shake { animation: shakeX 420ms cubic-bezier(.36,.07,.19,.97); }

      /* NEW: table rows are two-line cards for mobile */
      tr.entry-row { display: block; background: var(--input-bg); margin-bottom: 10px; border-radius: 12px; border: 1px solid var(--border); padding: 12px; }
      tr.entry-row td { display: block; border: none; padding: 0; }
      .entry-top { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
      .entry-bottom { display:flex; justify-content:space-between; align-items:center; gap:8px; }
      .entry-name { font-weight:700; font-size:15px; line-height:1.2; }
      .entry-price { font-weight:800; font-size:15px; }
      .entry-actions { display:flex; gap:8px; }
      .res-item { padding: 14px 20px; cursor: pointer; border-bottom: 1px solid var(--border); font-size: 15px; color: var(--text-main); font-weight: 600; }
      /* Center lens-style sheet selected item */
      .sheet-box { scroll-snap-type: y mandatory; }
      .sheet-item { scroll-snap-align: center; padding:16px; }
      .sheet-item.selected { background: rgba(0,0,0,0.03); border-radius: 12px; font-weight:800; color:var(--accent); }
      .header { display:flex; align-items:center; justify-content:space-between; margin-bottom:10px; }
      .nav { display:flex; gap:8px; margin-bottom:10px; }
      .nav-btn { padding:10px 12px; border-radius:10px; background:var(--input-bg); border:1px solid var(--border); cursor:pointer; font-weight:700; }
      .nav-btn.active { box-shadow: var(--shadow-card); border-color:var(--border-strong); }
      .content-area { flex:1; display:flex; flex-direction:column; overflow:hidden; }
      .tab-page { display:none; height:100%; }
      .tab-page.active { display:block; height:100%; }
      .split-view { display:flex; gap:12px; height:100%; }
      .panel { flex:1; background:var(--bg-panel); border-radius:16px; padding:12px; box-shadow: var(--shadow-card); display:flex; flex-direction:column; }
      .btn { padding:12px 16px; border-radius:10px; background:var(--accent); color:white; border:none; font-weight:700; cursor:pointer; }
      .btn-refresh { padding:6px 10px; border-radius:8px; background:transparent; border:1px solid var(--border); cursor:pointer; }
      .qty-wrapper { display:flex; gap:6px; align-items:center; }
      .qty-btn { padding:6px 10px; border-radius:8px; border:1px solid var(--border); background:var(--input-bg); cursor:pointer; }
      .qty-input { width:100%; padding:8px; border-radius:8px; border:1px solid var(--border); background:var(--input-bg); }

      .table-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
      #gridWrapper { overflow:auto; height:calc(100% - 60px); padding-right:6px; }
      #tableBody { display:block; padding:6px 0; }
      .toast { position:fixed; left:50%; transform:translateX(-50%); bottom:20px; background:#111; color:#fff; padding:8px 12px; border-radius:10px; display:none; z-index:999; }
      .toast.show { display:block; opacity:0.95; }
      .modal-overlay { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; background:rgba(0,0,0,0.3); z-index:999; }
      .modal-box { background:var(--input-bg); padding:20px; border-radius:12px; width:90%; max-width:500px; border:1px solid var(--border-strong); }
      .sheet-overlay { position:fixed; inset:0; display:none; align-items:center; justify-content:center; background:rgba(0,0,0,0.2); z-index:900; }
    </style>
</head>
<body data-theme="light">

    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <div class="header">
        <div style="display:flex;align-items:center;gap:10px">
            <div style="width:40px;height:40px;border-radius:50%;background:linear-gradient(90deg,#FFD700,#FF8C00)"></div>
            <div style="font-weight:800">–ú–∞—Å—Ç–µ—Ä—Å–∫–∞—è –í–µ–Ω–µ—Ä–∞</div>
        </div>
        <div>
            <button class="nav-btn" onclick="toggleTheme()">–¢–µ–º–∞</button>
        </div>
    </div>

    <div class="nav" id="navBar">
        <button class="nav-btn active" onclick="switchTab('income', 0)">–ú–ö</button>
        <button class="nav-btn" onclick="switchTab('expense', 1)">–†–∞—Å—Ö–æ–¥</button>
        <button class="nav-btn" onclick="switchTab('analytics', 2)">–ò–Ω—Ñ–æ</button>
    </div>

    <div class="content-area" id="contentArea">
        <div id="splitTab" class="tab-page active">
            <div class="split-view">
                <div class="panel panel-left">
                    <h3 id="formTitle">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</h3>
                    <div style="margin-bottom:8px">
                        <label id="lblSearch">–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                        <input type="text" id="inpName" placeholder="–ü–æ–∏—Å–∫ –∏–ª–∏ –Ω–æ–≤–æ–µ..." autocomplete="off" oninput="onNameInput(event);">
                        <div id="searchRes" style="max-height:120px; overflow:auto; margin-top:6px;"></div>
                    </div>
                    <div style="display:flex; gap:10px; margin-bottom:10px;">
                        <div style="flex:1">
                           <label>–¶–µ–Ω–∞</label>
                           <div class="qty-wrapper">
                               <button class="qty-btn" onclick="modVal('inpPrice', -100)">‚àí</button>
                               <input type="number" id="inpPrice" class="qty-input" placeholder="0" oninput="onPriceInput(event); calcTotal()">
                               <button class="qty-btn" onclick="modVal('inpPrice', 100)">+</button>
                           </div>
                        </div>
                        <div style="flex:1">
                           <label>–ö–æ–ª-–≤–æ</label>
                           <div class="qty-wrapper">
                               <button class="qty-btn" onclick="modVal('inpQty', -1)">‚àí</button>
                               <input type="number" id="inpQty" class="qty-input" value="1" oninput="onQtyInput(event); calcTotal()">
                               <button class="qty-btn" onclick="modVal('inpQty', 1)">+</button>
                           </div>
                        </div>
                    </div>
                    <div style="text-align:center; margin-top:auto; margin-bottom:5px; padding: 10px; background: var(--input-bg); border-radius: 16px; border: 1px solid var(--border);">
                        <span style="font-size:9px; color:var(--text-sub); text-transform:uppercase; font-weight:700; display:block; margin-bottom:2px;">–ò—Ç–æ–≥–æ –∫ –∑–∞–ø–∏—Å–∏</span>
                        <div id="txtTotal" style="font-size:24px; font-weight:800; color:var(--text-main)">0 ‚ÇΩ</div>
                    </div>
                    <button id="btnAdd" class="btn" onclick="submitEntry()">–î–æ–±–∞–≤–∏—Ç—å –∑–∞–ø–∏—Å—å</button>
                </div>

                <div class="panel panel-right">
                    <div class="table-header">
                        <h3 id="tableTitle" style="margin:0">–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏</h3>
                        <button class="btn-refresh" onclick="refreshTable(true)">–û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                    <div class="grid-wrapper" id="gridWrapper">
                        <table id="mainTable" style="width:100%">
                            <thead style="display:none">
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–î–µ–π—Å—Ç–≤–∏—è</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                        <div id="emptyMsg" style="padding:40px; text-align:center; color:var(--text-sub);">–ù–∞–∂–º–∏—Ç–µ "–û–±–Ω–æ–≤–∏—Ç—å" –¥–ª—è –∑–∞–≥—Ä—É–∑–∫–∏</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="analyticsTab" class="tab-page">
            <div style="display:flex;flex-direction:column;gap:12px;height:100%">
                <div style="display:flex;gap:12px; align-items:center">
                    <div style="flex:1; background:var(--input-bg); padding:10px; border-radius:10px; border:1px solid var(--border); cursor:pointer" onclick="openSheet('year')">
                        <div id="txtYear">–ì–æ–¥</div>
                    </div>
                    <div style="flex:1; background:var(--input-bg); padding:10px; border-radius:10px; border:1px solid var(--border); cursor:pointer" onclick="openSheet('month')">
                        <div id="txtMonth">–ú–µ—Å—è—Ü</div>
                    </div>
                </div>

                <div id="kpis" style="flex:0 0 auto;padding:10px;background:var(--input-bg);border-radius:12px;border:1px solid var(--border)"></div>
                <div id="charts" style="flex:1; overflow:auto; padding:10px; background:var(--input-bg); border-radius:12px; border:1px solid var(--border)"></div>
            </div>
        </div>
    </div>

    <!-- Modals -->
    <div id="editModal" class="modal-overlay" style="display:none">
        <div class="modal-box">
            <h3 style="margin-bottom:20px; color:var(--text-main)">–†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ</h3>
            <input type="hidden" id="editId">
            <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label><input type="text" id="editName" style="margin-bottom:15px;width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);">
            <div style="display:flex; gap:15px; margin-bottom:20px;">
                <div style="flex:1"><label>–¶–µ–Ω–∞</label><input type="number" id="editPrice" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)"></div>
                <div style="flex:1"><label>–ö–æ–ª-–≤–æ</label><input type="number" id="editQty" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)"></div>
            </div>
            <div style="display:flex; gap:10px;">
                <button class="btn" onclick="saveEdit()">–°–æ—Ö—Ä–∞–Ω–∏—Ç—å</button>
                <button class="btn" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--border-strong;" onclick="document.getElementById('editModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>
    <div id="deleteModal" class="modal-overlay" style="display:none">
        <div class="modal-box">
            <h3 style="margin-bottom:15px; color:var(--text-main)">–£–¥–∞–ª–µ–Ω–∏–µ</h3>
            <p style="color:var(--text-sub); margin-bottom:25px; font-size:14px; line-height:1.5;">–í—ã —É–≤–µ—Ä–µ–Ω—ã, —á—Ç–æ —Ö–æ—Ç–∏—Ç–µ —É–¥–∞–ª–∏—Ç—å —ç—Ç—É –∑–∞–ø–∏—Å—å? –≠—Ç–æ –¥–µ–π—Å—Ç–≤–∏–µ –Ω–µ–ª—å–∑—è –±—É–¥–µ—Ç –æ—Ç–º–µ–Ω–∏—Ç—å.</p>
            <div style="display:flex; gap:10px;">
                <button class="btn" style="background:var(--danger); color:white; margin-top:0;" onclick="confirmDelete()">–£–¥–∞–ª–∏—Ç—å</button>
                <button class="btn" style="background:var(--input-bg); color:var(--text-main); border:1px solid var(--border-strong); margin-top:0;" onclick="document.getElementById('deleteModal').style.display='none'">–û—Ç–º–µ–Ω–∞</button>
            </div>
        </div>
    </div>

    <div id="sheetModal" class="sheet-overlay" onclick="closeSheet(event)" style="display:none">
        <div class="sheet-box" id="sheetContent" style="width:90%; max-width:420px; background:var(--input-bg); padding:12px; border-radius:12px;">
            <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
                <div id="sheetTitle">–í—ã–±–æ—Ä</div>
                <div style="cursor:pointer" onclick="document.getElementById('sheetModal').style.display='none'">–ì–æ—Ç–æ–≤–æ</div>
            </div>
            <div id="sheetList" style="max-height:60vh; overflow:auto"></div>
        </div>
    </div>

    <script>
        // üëá –£–∫–∞–∂–∏ —Å—é–¥–∞ —Å–≤–æ–π –æ–ø—É–±–ª–∏–∫–æ–≤–∞–Ω–Ω—ã–π GAS URL (–µ—Å–ª–∏ –Ω–µ –∏—Å–ø–æ–ª—å–∑—É–µ—à—å google.script.run)
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbwvpjZO4C5PE6d61hrpVwTUcKcleV7YSZqDoYD_UR9OrGfIF9D90WR3C6uqjriFy_eQ/exec';
        const IS_GOOGLE = typeof google !== 'undefined' && google.script && google.script.run;
        let currTab = 'income', dataCache = { income: null, expense: null }, config = { incomeItems: [], expenseItems: [] }, charts = {};
        let selYear = new Date().getFullYear();
        let selMonth = new Date().getMonth();
        let availableYears = [];

        // -----------------------
        // HAPTICS / VIBRATION HELPERS
        // -----------------------
        function vib(pattern) {
            try {
                if (window.Telegram && Telegram.WebApp && Telegram.WebApp.HapticFeedback && typeof Telegram.WebApp.HapticFeedback.impactOccurred === 'function') {
                    if (pattern === 'light') Telegram.WebApp.HapticFeedback.impactOccurred('light');
                    else if (pattern === 'medium') Telegram.WebApp.HapticFeedback.impactOccurred('medium');
                    else if (pattern === 'strong') Telegram.WebApp.HapticFeedback.impactOccurred('heavy');
                    else if (Array.isArray(pattern)) { navigator.vibrate(pattern); }
                    return;
                }
            } catch(e) { /* ignore */ }

            if (navigator.vibrate) {
                if (pattern === 'light') navigator.vibrate(10);
                else if (pattern === 'medium') navigator.vibrate(30);
                else if (pattern === 'strong') navigator.vibrate([60,20,60]);
                else if (pattern === 'bounce') navigator.vibrate([15,10,15]);
                else if (Array.isArray(pattern)) navigator.vibrate(pattern);
            }
        }

        function onNameInput(e) { vib('light'); showSearch(e); }
        function onPriceInput(e) { vib('medium'); }
        function onQtyInput(e) { vib('medium'); }

        function invalidAddFeedback() {
            const btn = document.getElementById('btnAdd');
            btn.classList.remove('shake');
            void btn.offsetWidth;
            btn.classList.add('shake');
            vib('strong');
        }

        // -----------------------
        // BACKEND COMM
        // -----------------------
        async function runBackend(action, payload = {}) {
            if (IS_GOOGLE) {
                return new Promise((resolve, reject) => {
                    if(action === 'getInitialConfig') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getInitialConfig();
                    else if(action === 'saveTransaction') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).saveTransaction(payload);
                    else if(action === 'getTableData') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getTableData(payload.type);
                    else if(action === 'editTransaction') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).editTransaction(payload);
                    else if(action === 'deleteTransaction') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).deleteTransaction(payload);
                    else if(action === 'getAnalyticsData') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getAnalyticsData(payload.year, payload.monthIdx);
                    else reject("Unknown Func");
                });
            } else {
                payload.action = action;
                const res = await fetch(GAS_URL, {
                    method: "POST",
                    headers: { "Content-Type": "text/plain;charset=utf-8" },
                    body: JSON.stringify(payload)
                });
                const text = await res.text();
                try { return JSON.parse(text); } catch(e) { throw new Error("Server Error: " + text); }
            }
        }

        // -----------------------
        // INIT
        // -----------------------
        window.onload = function() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.body.setAttribute('data-theme', savedTheme);
            setLoading(true);
            runBackend('getInitialConfig').then(res => {
                config = res;
                availableYears = res.years;
                updateFilterUI();
                refreshTable(true);
                loadAnalytics(true);
                setLoading(false);
            }).catch(e => { setLoading(false); });

            initSwipePaging();
        };

        function setLoading(active) {
            // visual hint can be extended
        }

        function switchTab(t, idx) {
            currTab = t;
            const btns = document.querySelectorAll('.nav-btn');
            btns.forEach(b => b.classList.remove('active')); 
            if(typeof idx === 'undefined') {
                if(t==='income') idx=0; else if(t==='expense') idx=1; else idx=2;
            }
            if(btns[idx]) btns[idx].classList.add('active');
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            if(t === 'analytics') {
                document.getElementById('analyticsTab').classList.add('active');
                loadAnalytics();
            } else {
                document.getElementById('splitTab').classList.add('active');
                updateUIForTab(t);
                refreshTable(true);
            }
            vib('medium');
        }

        function updateUIForTab(t) {
            const isInc = t === 'income';
            document.getElementById('formTitle').innerText = isInc ? '–î–æ–±–∞–≤–∏—Ç—å –ú–∞—Å—Ç–µ—Ä –ö–ª–∞—Å—Å' : '–î–æ–±–∞–≤–∏—Ç—å –†–∞—Å—Ö–æ–¥';
            document.getElementById('lblSearch').innerText = isInc ? '–ù–∞–∑–≤–∞–Ω–∏–µ –ú–ö' : '–ù–∞–∏–º–µ–Ω–æ–≤–∞–Ω–∏–µ';
            document.getElementById('tableTitle').innerText = isInc ? '–î–æ—Ö–æ–¥—ã (–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏)' : '–†–∞—Å—Ö–æ–¥—ã (–ü–æ—Å–ª–µ–¥–Ω–∏–µ –∑–∞–ø–∏—Å–∏)';
            document.getElementById('inpName').value = ''; document.getElementById('inpPrice').value = ''; document.getElementById('inpQty').value = 1;
            calcTotal();
        }

        function updateFilterUI() {
            document.getElementById('txtYear').innerText = selYear;
            document.getElementById('txtMonth').innerText = (selMonth === 'all') ? '–í–µ—Å—å –≥–æ–¥' : ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'][selMonth];
        }

        function openSheet(type) {
            const sheet = document.getElementById('sheetModal');
            const list = document.getElementById('sheetList');
            const title = document.getElementById('sheetTitle');
            list.innerHTML = '';
            sheet.style.display = 'flex';
            if (type === 'year') {
                title.innerText = '–í—ã–±–µ—Ä–∏—Ç–µ –≥–æ–¥';
                availableYears.forEach(y => {
                    const div = document.createElement('div');
                    div.className = `sheet-item ${y == selYear ? 'selected' : ''}`;
                    div.innerText = y;
                    div.onclick = () => { selYear = y; updateFilterUI(); sheet.style.display = 'none'; loadAnalytics(); vib('medium'); };
                    list.appendChild(div);
                });
            } else {
                title.innerText = '–í—ã–±–µ—Ä–∏—Ç–µ –º–µ—Å—è—Ü';
                const divAll = document.createElement('div');
                divAll.className = `sheet-item ${selMonth === 'all' ? 'selected' : ''}`;
                divAll.innerText = '–í–µ—Å—å –≥–æ–¥';
                divAll.onclick = () => { selMonth = 'all'; updateFilterUI(); sheet.style.display = 'none'; loadAnalytics(); vib('medium'); };
                list.appendChild(divAll);
                ['–Ø–Ω–≤–∞—Ä—å','–§–µ–≤—Ä–∞–ª—å','–ú–∞—Ä—Ç','–ê–ø—Ä–µ–ª—å','–ú–∞–π','–ò—é–Ω—å','–ò—é–ª—å','–ê–≤–≥—É—Å—Ç','–°–µ–Ω—Ç—è–±—Ä—å','–û–∫—Ç—è–±—Ä—å','–ù–æ—è–±—Ä—å','–î–µ–∫–∞–±—Ä—å'].forEach((m, i) => {
                    const div = document.createElement('div');
                    div.className = `sheet-item ${i === selMonth ? 'selected' : ''}`;
                    div.innerText = m;
                    div.onclick = () => { selMonth = i; updateFilterUI(); sheet.style.display = 'none'; loadAnalytics(); vib('medium'); };
                    list.appendChild(div);
                });
            }
            list.addEventListener('scroll', onSheetScroll);
        }
        function closeSheet(e) {
            if (e.target.id === 'sheetModal') document.getElementById('sheetModal').style.display = 'none';
        }
        function onSheetScroll(e) { vib('light'); }

        // -----------------------
        // TABLE / ROW RENDERING
        // -----------------------
        function renderTableFromCache(data) {
             const tbody = document.getElementById('tableBody'), msg = document.getElementById('emptyMsg');
             if(!data || !data.length) { tbody.innerHTML = ''; msg.style.display = 'block'; msg.innerText = '–°–ø–∏—Å–æ–∫ –ø—É—Å—Ç'; return; }
             msg.style.display = 'none';
             tbody.innerHTML = '';
             data.forEach(row => {
                 const rowJson = JSON.stringify(row).replace(/"/g, '&quot;');
                 const html = `<tr id="row-${row.rowId}" class="entry-row" data-row='${rowJson}'>
                    <td>
                      <div class="entry-top"><div style="color:var(--text-sub)">${row.dateStr}</div><div class="entry-price">${row.total.toLocaleString()} ‚ÇΩ</div></div>
                      <div class="entry-bottom"><div class="entry-name">${row.name}</div>
                      <div class="entry-actions"><button class="btn-table btn-edit" onclick='openEdit(${rowJson})'>‚úé</button><button class="btn-table btn-del" onclick='openDelete(${rowJson})'>‚úï</button></div>
                      </div>
                    </td>
                 </tr>`;
                 tbody.insertAdjacentHTML('beforeend', html);
             });

             const items = Array.from(tbody.querySelectorAll('.entry-row'));
             const observer = new IntersectionObserver((entries) => {
                 entries.forEach(en => {
                     if(en.isIntersecting) {
                         vib('light');
                     }
                 });
             }, { root: document.querySelector('#gridWrapper'), threshold: 0.9 });
             items.forEach(i => observer.observe(i));
        }

        function refreshTable(force = false) {
            const tbody = document.getElementById('tableBody'), msg = document.getElementById('emptyMsg');
            msg.style.display = 'block';
            msg.innerText = '–ó–∞–≥—Ä—É–∑–∫–∞...';
            runBackend('getTableData', {type: currTab}).then(data => {
                dataCache[currTab] = data; renderTableFromCache(data); 
            }).catch(e=> { msg.innerText = '–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏'; });
        }

        // -----------------------
        // SUBMIT / VALIDATION (with vib/shake)
        // -----------------------
        function calcTotal() {
            const p = parseFloat(document.getElementById('inpPrice').value) || 0;
            const q = parseFloat(document.getElementById('inpQty').value) || 0;
            document.getElementById('txtTotal').innerText = (p*q).toLocaleString() + ' ‚ÇΩ';
        }

        function submitEntry() {
            const name = document.getElementById('inpName').value.trim();
            const priceVal = document.getElementById('inpPrice').value;
            const price = parseFloat(priceVal);
            const qty = parseFloat(document.getElementById('inpQty').value) || 1;
            if(!name || !priceVal || isNaN(price) || price<=0) { invalidAddFeedback(); return; }
            const total = price * qty;
            const list = currTab === 'income' ? config.incomeItems : config.expenseItems;
            const isNew = !list.includes(name);
            if(isNew) list.push(name);
            const payload = { type: currTab, name: name, price: price, qty: qty, total: total, isNew: isNew };
            const tbody = document.getElementById('tableBody');
            document.getElementById('emptyMsg').style.display = 'none';
            const tempId = 'temp-' + Date.now();
            const shortDate = new Date().toLocaleDateString('ru-RU', {day:'2-digit', month:'2-digit', year:'2-digit'});
            tbody.insertAdjacentHTML('afterbegin', `<tr id="${tempId}" class="entry-row" style="background: rgba(0,0,0,0.03);"><td><div class="entry-top"><div style="color:var(--text-sub)">${shortDate}</div><div class="entry-price">${total.toLocaleString()} ‚ÇΩ</div></div><div class="entry-bottom"><div class="entry-name">${name}</div><div class="entry-actions"><span style="color:var(--text-sub)">...</span></div></div></td></tr>`);
            document.getElementById('inpName').value = ''; document.getElementById('inpPrice').value = ''; document.getElementById('inpQty').value = 1; calcTotal();
            const btn = document.getElementById('btnAdd'); btn.disabled = true;
            runBackend('saveTransaction', payload).then(res => {
                btn.disabled = false;
                if(res.success) { showToast('–£—Å–ø–µ—à–Ω–æ –¥–æ–±–∞–≤–ª–µ–Ω–æ'); refreshTable(true); vib('bounce'); } 
                else { const tempEl = document.getElementById(tempId); if(tempEl) tempEl.remove(); showToast(res.message, true); document.getElementById('inpName').value = name; document.getElementById('inpPrice').value = price; }
            }).catch(e=> { btn.disabled=false; showToast('–û—à–∏–±–∫–∞', true); });
        }

        // -----------------------
        // EDIT / DELETE (stronger vibration)
        // -----------------------
        let deleteTargetId = null;
        function openEdit(row) {
            document.getElementById('editId').value = row.rowId;
            document.getElementById('editName').value = row.name; document.getElementById('editPrice').value = row.price; document.getElementById('editQty').value = row.qty; document.getElementById('editModal').style.display = 'flex';
            vib('medium');
        }
        function saveEdit() {
            const id = document.getElementById('editId').value, name = document.getElementById('editName').value, price = parseFloat(document.getElementById('editPrice').value), qty = parseFloat(document.getElementById('editQty').value);
            const payload = { rowId: id, type: currTab, name: name, price: price, qty: qty };
            document.getElementById('editModal').style.display = 'none';
            vib('strong');
            runBackend('editTransaction', payload).then(res => {
                if(res.success) { showToast('–°–æ—Ö—Ä–∞–Ω–µ–Ω–æ'); refreshTable(true); vib('medium'); } else { showToast(res.message, true); refreshTable(true); }
            });
        }
        function openDelete(row) { deleteTargetId = row.rowId; document.getElementById('deleteModal').style.display = 'flex'; vib('strong'); }
        function confirmDelete() {
            if(!deleteTargetId) return;
            document.getElementById('deleteModal').style.display = 'none';
            vib('strong');
            runBackend('deleteTransaction', {rowId: deleteTargetId, type: currTab}).then(res => {
                if(res.success) { showToast('–£–¥–∞–ª–µ–Ω–æ'); refreshTable(true); vib('medium'); } else { showToast(res.message, true); refreshTable(true); }
            });
        }

        // -----------------------
        // ANALYTICS: load and simple chart interaction vibration
        // -----------------------
        function loadAnalytics() {
            runBackend('getAnalyticsData', {year: selYear, monthIdx: selMonth}).then(d => {
                // –ø—Ä–æ—Å—Ç–∞—è –æ—Ç—Ä–∏—Å–æ–≤–∫–∞ –∑–∞–≥–ª—É—à–µ–∫ ‚Äî –º–æ–∂–Ω–æ —Ä–∞—Å—à–∏—Ä–∏—Ç—å
                document.getElementById('kpis').innerHTML = `<div style="display:flex;gap:8px;flex-wrap:wrap"><div style="flex:1;padding:10px;border-radius:8px;background:var(--input-bg);border:1px solid var(--border)"><div style="font-weight:800">${d.current.income || 0} ‚ÇΩ</div><div style="color:var(--text-sub)">–î–æ—Ö–æ–¥</div></div><div style="flex:1;padding:10px;border-radius:8px;background:var(--input-bg);border:1px solid var(--border)"><div style="font-weight:800">${d.current.expense || 0} ‚ÇΩ</div><div style="color:var(--text-sub)">–†–∞—Å—Ö–æ–¥</div></div></div>`;
                document.getElementById('charts').innerHTML = '<div style="padding:16px;">(–ì—Ä–∞—Ñ–∏–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã)</div>';
                vib('medium');
            }).catch(e=>{ showToast('–û—à–∏–±–∫–∞ –∞–Ω–∞–ª–∏—Ç–∏–∫–∏', true); });
        }

        document.addEventListener('pointerdown', function(e){
            const canvas = e.target.closest('canvas');
            if(canvas) vib('light');
        });

        // -----------------------
        // HELPERS / TOAST
        // -----------------------
        function showToast(msg, isError) {
            const t = document.getElementById('toast');
            t.innerText = msg; t.className = 'toast show' + (isError? ' error':'' );
            setTimeout(()=> t.className = 'toast', 1800);
        }

        // -----------------------
        // SWIPE PAGING (80px)
        // -----------------------
        function initSwipePaging() {
            let startX = null, startY = null;
            let accX = 0;
            const el = document.getElementById('contentArea');
            el.addEventListener('touchstart', (e) => { startX = e.touches[0].clientX; startY = e.touches[0].clientY; accX = 0; }, {passive:true});
            el.addEventListener('touchmove', (e) => {
                if(startX === null) return;
                const dx = e.touches[0].clientX - startX;
                const dy = Math.abs(e.touches[0].clientY - startY);
                if(dy > 80) return;
                accX = dx;
            }, {passive:true});
            el.addEventListener('touchend', (e) => {
                if(startX === null) return;
                if(Math.abs(accX) > 80) {
                    const order = ['income','expense','analytics'];
                    let idx = order.indexOf(currTab);
                    if(accX < 0) idx = (idx + 1) % order.length; else idx = (idx - 1 + order.length) % order.length;
                    switchTab(order[idx], idx);
                }
                startX = null; accX = 0;
            });
        }

        function modVal(id, delta) {
            const el = document.getElementById(id);
            let v = parseFloat(el.value || 0) || 0;
            v += delta;
            el.value = v;
            calcTotal();
            vib('light');
        }

        function toggleTheme() {
            const t = document.body.getAttribute('data-theme') === 'dark' ? 'light' : 'dark';
            document.body.setAttribute('data-theme', t);
            localStorage.setItem('theme', t);
            vib('light');
        }

        // -----------------------
        // SIMPLE SEARCH DISPLAY (–ª–æ–∫–∞–ª—å–Ω–æ)
        // -----------------------
        function showSearch(e) {
            const q = (e.target.value || '').toLowerCase();
            const wrap = document.getElementById('searchRes');
            wrap.innerHTML = '';
            if(!q) return;
            const list = currTab === 'income' ? config.incomeItems : config.expenseItems;
            const filtered = list.filter(i => i.toLowerCase().includes(q)).slice(0,8);
            filtered.forEach(it => {
                const div = document.createElement('div');
                div.className = 'res-item';
                div.innerText = it;
                div.onclick = () => { document.getElementById('inpName').value = it; wrap.innerHTML = ''; vib('medium'); };
                wrap.appendChild(div);
            });
        }
    </script>
</body>
</html>
