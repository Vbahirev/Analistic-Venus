<!DOCTYPE html>
<html>
<head>
    <base target="_top">
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Venus Workshop</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <style>
      :root { 
        --bg-app: #F2F2F7;
        --bg-panel: #FFFFFF;      
        --text-main: #000000;     
        --text-sub: #8E8E93;      
        --accent: #007AFF;        
        --border: rgba(0,0,0,0.1); 
        --border-strong: #C7C7CC;
        --input-bg: #F2F2F7;      
        
        --color-inc: #34C759;
        --color-exp: #FF3B30;     
        --color-prof: #5856D6;    
        --color-vis: #AF52DE;
        
        --danger: #FF3B30;
        --shadow-card: 0 4px 12px rgba(0,0,0,0.05);
        --radius: 16px;
        --nav-height: 60px; /* –í—ã—Å–æ—Ç–∞ –º–µ–Ω—é –Ω–∞ –ü–ö */
      }
      
      [data-theme="dark"] { 
        --bg-app: #000000;
        --bg-panel: #1C1C1E; 
        --text-main: #FFFFFF;     
        --text-sub: #98989D;      
        --accent: #0A84FF;        
        --border: #38383A;        
        --border-strong: #48484A;
        --input-bg: #2C2C2E;      
        
        --shadow-card: 0 4px 20px rgba(0,0,0,0.5);
        --color-inc: #30D158;     
        --color-exp: #FF453A;     
        --color-prof: #5E5CE6;    
        --color-vis: #BF5AF2;     
      }
      
      /* --- –û–°–ù–û–í–ù–ê–Ø –°–¢–†–£–ö–¢–£–†–ê --- */
      body { 
          margin: 0;
          padding: 20px;
          padding-top: 80px; /* –û—Ç—Å—Ç—É–ø –ø–æ–¥ —Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω–Ω–æ–µ –º–µ–Ω—é –ü–ö */
          font-family: 'Inter', -apple-system, sans-serif; 
          background-color: var(--bg-app); 
          color: var(--text-main); 
          min-height: 100vh;
          box-sizing: border-box; 
          -webkit-font-smoothing: antialiased;
          display: flex;
          flex-direction: column;
      }

      /* --- –ù–ê–í–ò–ì–ê–¶–ò–Ø (–ú–ï–ù–Æ) --- */
      .nav { 
          display: flex; 
          gap: 10px;
          background: var(--bg-panel); 
          padding: 10px 20px; 
          box-shadow: 0 1px 0 var(--border); 
          z-index: 1000;
          
          /* –ü–ö –°–¢–ò–õ–¨: –°–í–ï–†–•–£ */
          position: fixed;
          top: 0;
          left: 0;
          width: 100%;
          box-sizing: border-box;
          height: var(--nav-height);
          align-items: center;
          border-bottom: 1px solid var(--border);
      }

      .nav-btn { 
          flex: 1; 
          max-width: 200px; /* –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ —à–∏—Ä–∏–Ω—ã –Ω–∞ –ü–ö */
          padding: 8px 16px; 
          border: none; 
          background: transparent; 
          color: var(--text-sub); 
          border-radius: 10px; 
          cursor: pointer; 
          font-weight: 600; 
          font-size: 14px; 
          transition: 0.2s; 
          display: flex;
          align-items: center;
          justify-content: center;
          gap: 8px;
      }
      
      .nav-btn svg {
          width: 20px;
          height: 20px;
          fill: currentColor;
          opacity: 0.7;
      }

      .nav-btn:hover { background: var(--bg-app); color: var(--text-main); }
      .nav-btn.active { background: var(--input-bg); color: var(--accent); }
      .nav-btn.active svg { opacity: 1; }

      /* –ë–†–ï–ù–î (–õ–û–ì–û–¢–ò–ü) –í –ú–ï–ù–Æ */
      .brand-box { 
          display: flex; 
          align-items: center; 
          gap: 10px; 
          margin-right: auto; /* –û—Ç–æ–¥–≤–∏–≥–∞–µ—Ç –∫–Ω–æ–ø–∫–∏ –≤–ø—Ä–∞–≤–æ */
      }
      .venus-icon { width: 32px; height: 32px; }
      .title { font-size: 18px; font-weight: 700; color: var(--text-main); }

      /* –¢–ï–ú–ê */
      .theme-toggle-btn {
          width: 36px; height: 36px; border-radius: 50%; background: var(--input-bg); 
          cursor: pointer; display: flex; align-items: center; justify-content: center; 
          border: none; margin-left: 10px; color: var(--text-main);
      }

      /* --- –ö–û–ù–¢–ï–ù–¢ --- */
      .content-area { flex: 1; width: 100%; max-width: 1200px; margin: 0 auto; }
      .tab-page { display: none; animation: fadeIn 0.3s ease; }
      .tab-page.active { display: block; }
      @keyframes fadeIn { from { opacity: 0; transform: translateY(5px); } to { opacity: 1; transform: translateY(0); } }

      /* –ü–ê–ù–ï–õ–ò (–ö–∞—Ä—Ç–æ—á–∫–∏) */
      .split-view { display: flex; gap: 20px; align-items: flex-start; }
      .panel { 
          background: var(--bg-panel); 
          border-radius: var(--radius); 
          box-shadow: var(--shadow-card); 
          border: 1px solid var(--border); 
          overflow: hidden;
      }
      
      .panel-left { width: 350px; padding: 25px; box-sizing: border-box; position: sticky; top: 90px; }
      .panel-right { flex: 1; min-width: 0; }

      /* –¢–ê–ë–õ–ò–¶–ê */
      .table-header { padding: 20px; border-bottom: 1px solid var(--border); display: flex; justify-content: space-between; align-items: center; }
      .grid-wrapper { padding: 0; overflow-x: auto; }
      table { width: 100%; border-collapse: collapse; min-width: 600px; }
      th { text-align: left; padding: 12px 20px; color: var(--text-sub); font-size: 12px; text-transform: uppercase; border-bottom: 1px solid var(--border); background: var(--bg-panel); }
      td { padding: 16px 20px; border-bottom: 1px solid var(--border); font-size: 14px; }
      tr:last-child td { border-bottom: none; }
      
      /* –≠–õ–ï–ú–ï–ù–¢–´ –§–û–†–ú–´ */
      input, select { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border-strong); background: var(--input-bg); color: var(--text-main); font-size: 15px; box-sizing: border-box; margin-bottom: 15px; outline: none; }
      input:focus { border-color: var(--accent); }
      label { display: block; font-size: 12px; font-weight: 600; color: var(--text-sub); margin-bottom: 6px; }
      .btn { width: 100%; padding: 14px; background: var(--accent); color: white; border: none; border-radius: 12px; font-weight: 600; cursor: pointer; font-size: 16px; }
      
      /* –ö–û–õ–ò–ß–ï–°–¢–í–û (+ -) */
      .qty-wrapper { display: flex; align-items: center; gap: 10px; margin-bottom: 15px; }
      .qty-btn { width: 40px; height: 40px; border-radius: 10px; border: 1px solid var(--border-strong); background: var(--bg-panel); color: var(--text-main); cursor: pointer; font-size: 18px; }
      .qty-input { text-align: center; margin: 0; font-weight: bold; }

      /* –ê–ù–ê–õ–ò–¢–ò–ö–ê (–°–µ—Ç–∫–∞) */
      .kpi-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
      .kpi-card { background: var(--bg-panel); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); }
      .kpi-val { font-size: 24px; font-weight: 800; margin: 5px 0; }
      .charts-grid { display: grid; grid-template-columns: 2fr 1fr; gap: 20px; margin-bottom: 20px; }
      .chart-box { background: var(--bg-panel); padding: 20px; border-radius: var(--radius); border: 1px solid var(--border); min-height: 300px; }

      /* –£–≤–µ–¥–æ–º–ª–µ–Ω–∏—è –∏ –ó–∞–≥—Ä—É–∑–∫–∞ */
      .toast { position: fixed; bottom: 30px; left: 50%; transform: translateX(-50%); background: #333; color: white; padding: 10px 20px; border-radius: 50px; opacity: 0; pointer-events: none; transition: 0.3s; z-index: 2000; }
      .toast.show { opacity: 1; bottom: 50px; }
      .loader { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.1); z-index: 1500; display: none; cursor: wait; }

      /* –≠–ö–†–ê–ù –î–û–°–¢–£–ü–ê */
      #accessDenied { position: fixed; top:0; left:0; width:100%; height:100%; background:var(--bg-app); z-index:9999; display:flex; flex-direction:column; align-items:center; justify-content:center; text-align:center; padding:20px; }

      /* --- –ú–û–ë–ò–õ–¨–ù–ê–Ø –í–ï–†–°–ò–Ø --- */
      @media (max-width: 900px) {
          body {
              padding: 15px;
              padding-top: 15px;
              padding-bottom: 100px; /* –ú–µ—Å—Ç–æ –ø–æ–¥ –Ω–∏–∂–Ω–µ–µ –º–µ–Ω—é */
          }

          /* –ü–ï–†–ï–ù–û–° –ú–ï–ù–Æ –í–ù–ò–ó */
          .nav {
              top: auto;
              bottom: 0;
              height: auto;
              padding: 10px 15px;
              padding-bottom: calc(10px + env(safe-area-inset-bottom));
              border-top: 1px solid var(--border);
              border-bottom: none;
              box-shadow: 0 -4px 20px rgba(0,0,0,0.05);
              background: rgba(255,255,255,0.85); /* –ü–æ–ª—É–ø—Ä–æ–∑—Ä–∞—á–Ω–æ—Å—Ç—å */
              backdrop-filter: blur(12px);
              -webkit-backdrop-filter: blur(12px);
              justify-content: space-around;
          }
          [data-theme="dark"] .nav { background: rgba(28,28,30,0.85); }

          /* –°–ö–†–´–í–ê–ï–ú –õ–û–ì–û–¢–ò–ü –ò –¢–ï–ú–£ –í –ù–ò–ñ–ù–ï–ú –ú–ï–ù–Æ (—á—Ç–æ–±—ã –≤–ª–µ–∑–ª–∏ –∫–Ω–æ–ø–∫–∏) */
          .brand-box, .theme-toggle-btn { display: none; }

          /* –ö–ù–û–ü–ö–ò –ú–ï–ù–Æ –ù–ê –¢–ï–õ–ï–§–û–ù–ï */
          .nav-btn {
              flex-direction: column; /* –ò–∫–æ–Ω–∫–∞ —Å–≤–µ—Ä—Ö—É, —Ç–µ–∫—Å—Ç —Å–Ω–∏–∑—É */
              padding: 6px;
              gap: 4px;
              font-size: 10px;
              border-radius: 8px;
              max-width: none;
          }
          .nav-btn svg { width: 24px; height: 24px; }

          /* –ê–î–ê–ü–¢–ê–¶–ò–Ø –ö–û–ù–¢–ï–ù–¢–ê */
          .split-view { flex-direction: column; }
          .panel-left { width: 100%; position: static; margin-bottom: 20px; }
          .kpi-grid { grid-template-columns: 1fr 1fr; }
          .charts-grid { grid-template-columns: 1fr; }
          
          /* –¢–∞–±–ª–∏—Ü–∞ –Ω–∞ –º–æ–±–∏–ª—å–Ω–æ–º */
          table { min-width: 100%; }
          th, td { padding: 10px; }
          th:nth-child(1), td:nth-child(1) { width: 25%; } /* –î–∞—Ç–∞ */
          th:nth-child(2), td:nth-child(2) { width: auto; } /* –ù–∞–∑–≤–∞–Ω–∏–µ */
          th:nth-child(3), td:nth-child(3) { width: 25%; text-align:right;} /* –°—É–º–º–∞ */
          th:nth-child(4), td:nth-child(4) { display: none; } /* –°–∫—Ä—ã–≤–∞–µ–º –¥–µ–π—Å—Ç–≤–∏—è, –¥–µ–ª–∞–µ–º –∫–ª–∏–∫ –ø–æ —Å—Ç—Ä–æ–∫–µ –¥–ª—è —Ä–µ–¥–∞–∫—Ç–∞ */
      }
    </style>
</head>
<body data-theme="light">

    <div id="accessDenied" style="display: none;">
        <div style="font-size: 50px; margin-bottom: 20px;">üîí</div>
        <h2>–î–æ—Å—Ç—É–ø –æ–≥—Ä–∞–Ω–∏—á–µ–Ω</h2>
        <p style="color: var(--text-sub);">–í–∞—à ID –Ω–µ –Ω–∞–π–¥–µ–Ω –≤ —Å–ø–∏—Å–∫–µ —Ä–∞–∑—Ä–µ—à–µ–Ω–Ω—ã—Ö.</p>
        <div id="userIdDisplay" style="margin-top:10px; padding:10px; background:var(--bg-panel); border-radius:8px; font-family:monospace;"></div>
    </div>

    <div id="loader" class="loader"></div>
    <div id="toast" class="toast">–°–æ–æ–±—â–µ–Ω–∏–µ</div>

    <div class="nav">
        <div class="brand-box">
            <svg class="venus-icon" viewBox="0 0 100 100">
                <circle cx="50" cy="50" r="48" fill="orange"/>
                <path d="M15 30 Q 50 20 85 30 M 10 50 Q 50 40 90 50 M 15 70 Q 50 80 85 70" stroke="white" stroke-width="4" fill="none"/>
            </svg>
            <span class="title">–í–µ–Ω–µ—Ä–∞</span>
        </div>

        <button class="nav-btn active" onclick="switchTab('income')">
            <svg viewBox="0 0 24 24"><path d="M12 2l3.09 6.26L22 9.27l-5 4.87 1.18 6.88L12 17.77l-6.18 3.25L7 14.14 2 9.27l6.91-1.01L12 2z"/></svg>
            –ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å—ã
        </button>
        <button class="nav-btn" onclick="switchTab('expense')">
            <svg viewBox="0 0 24 24"><path d="M19 6h-2c0-2.76-2.24-5-5-5S7 3.24 7 6H5c-1.1 0-2 .9-2 2v12c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V8c0-1.1-.9-2-2-2zm-7-3c1.66 0 3 1.34 3 3H9c0-1.66 1.34-3 3-3zm7 15H5V8h14v10zm-7-8c-2.21 0-4 1.79-4 4s1.79 4 4 4 4-1.79 4-4-1.79-4-4-4z"/></svg>
            –†–∞—Å—Ö–æ–¥–Ω–∏–∫–∏
        </button>
        <button class="nav-btn" onclick="switchTab('analytics')">
            <svg viewBox="0 0 24 24"><path d="M19 3H5c-1.1 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2V5c0-1.1-.9-2-2-2zM9 17H7v-7h2v7zm4 0h-2V7h2v10zm4 0h-2v-4h2v4z"/></svg>
            –ê–Ω–∞–ª–∏—Ç–∏–∫–∞
        </button>

        <button class="theme-toggle-btn" onclick="toggleTheme()">‚óë</button>
    </div>

    <div class="content-area">
        
        <div id="splitTab" class="tab-page active">
           <div class="split-view">
                <div class="panel panel-left">
                    <h3 id="formTitle">–ù–æ–≤–∞—è –∑–∞–ø–∏—Å—å</h3>
                    
                    <label>–ù–∞–∑–≤–∞–Ω–∏–µ</label>
                    <div style="position:relative; margin-bottom:15px;">
                        <input type="text" id="inpName" placeholder="–ü–æ–∏—Å–∫..." oninput="showSearch(event); calcTotal()" autocomplete="off" style="margin:0;">
                        <div id="searchRes" style="position:absolute; top:100%; left:0; width:100%; background:var(--bg-panel); border:1px solid var(--border); z-index:10; display:none; max-height:150px; overflow-y:auto; box-shadow:0 4px 10px rgba(0,0,0,0.1);"></div>
                    </div>

                    <div style="display:flex; gap:10px;">
                        <div style="flex:1">
                            <label>–¶–µ–Ω–∞</label>
                            <input type="number" id="inpPrice" placeholder="0" oninput="calcTotal()">
                        </div>
                        <div style="flex:1">
                             <label>–ö–æ–ª-–≤–æ</label>
                             <div class="qty-wrapper" style="margin-bottom:0;">
                                 <button class="qty-btn" onclick="modVal('inpQty', -1)">‚àí</button>
                                 <input type="number" id="inpQty" class="qty-input" value="1" style="width:40px; border:none; background:transparent; margin:0;" oninput="calcTotal()">
                                 <button class="qty-btn" onclick="modVal('inpQty', 1)">+</button>
                             </div>
                        </div>
                    </div>

                    <div style="margin-top:20px; padding:15px; background:var(--input-bg); border-radius:12px; text-align:center;">
                        <div style="font-size:12px; color:var(--text-sub);">–ò–¢–û–ì–û</div>
                        <div id="txtTotal" style="font-size:24px; font-weight:800;">0 ‚ÇΩ</div>
                    </div>
                    
                    <button id="btnAdd" class="btn" style="margin-top:15px;" onclick="submitEntry()">–î–æ–±–∞–≤–∏—Ç—å</button>
                </div>

                <div class="panel panel-right">
                    <div class="table-header">
                        <h3 id="tableTitle" style="margin:0">–ò—Å—Ç–æ—Ä–∏—è</h3>
                        <button onclick="refreshTable(true)" style="background:none; border:none; color:var(--accent); cursor:pointer; font-weight:600;">‚Üª –û–±–Ω–æ–≤–∏—Ç—å</button>
                    </div>
                    <div class="grid-wrapper">
                        <table id="mainTable">
                            <thead>
                                <tr>
                                    <th>–î–∞—Ç–∞</th>
                                    <th>–ù–∞–∑–≤–∞–Ω–∏–µ</th>
                                    <th>–°—É–º–º–∞</th>
                                    <th>–ò–Ω—Ñ–æ</th>
                                </tr>
                            </thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                        <div id="emptyMsg" style="padding:30px; text-align:center; color:var(--text-sub);">–ó–∞–≥—Ä—É–∑–∫–∞...</div>
                    </div>
                </div>
            </div>
        </div>

        <div id="analyticsTab" class="tab-page">
            <div style="display:flex; gap:10px; margin-bottom:20px;">
                <select id="anYear" onchange="loadAnalytics()"></select>
                <select id="anMonth" onchange="loadAnalytics()"></select>
            </div>

            <div class="kpi-grid">
                <div class="kpi-card"><div style="font-size:12px; color:var(--text-sub)">–î–û–•–û–î</div><div id="kpiInc" class="kpi-val" style="color:var(--color-inc)">0</div></div>
                <div class="kpi-card"><div style="font-size:12px; color:var(--text-sub)">–†–ê–°–•–û–î</div><div id="kpiExp" class="kpi-val" style="color:var(--color-exp)">0</div></div>
                <div class="kpi-card"><div style="font-size:12px; color:var(--text-sub)">–ü–†–ò–ë–´–õ–¨</div><div id="kpiProf" class="kpi-val" style="color:var(--color-prof)">0</div></div>
                <div class="kpi-card"><div style="font-size:12px; color:var(--text-sub)">–õ–Æ–î–ò</div><div id="kpiVis" class="kpi-val" style="color:var(--color-vis)">0</div></div>
            </div>

            <div class="charts-grid">
                <div class="chart-box">
                    <h3>–§–∏–Ω–∞–Ω—Å—ã</h3>
                    <canvas id="chartPulse"></canvas>
                </div>
                <div class="chart-box">
                    <h3>–¢–æ–ø –î–æ—Ö–æ–¥–æ–≤</h3>
                    <div id="listInc"></div>
                </div>
            </div>
             <div class="charts-grid">
                <div class="chart-box">
                    <h3>–ü–æ—Å–µ—Ç–∏—Ç–µ–ª–∏</h3>
                    <canvas id="chartAttendance"></canvas>
                </div>
                <div class="chart-box">
                    <h3>–¢–æ–ø –†–∞—Å—Ö–æ–¥–æ–≤</h3>
                    <div id="listExp"></div>
                </div>
            </div>
        </div>

    </div>

    <script>
        // üëá –í–°–¢–ê–í–¨ –°–Æ–î–ê –°–í–û–Æ –°–°–´–õ–ö–£ –ò–ó DEPLOYMENT!
        const GAS_URL = 'https://script.google.com/macros/s/AKfycbyDN6u9RdE9wD0bO4XetH2fmgD-I5XJQo_MhhyIvLGHg3Ub_NCLTUVdjkfAPkNrbF17/exec';
        
        // ID –ê–¥–º–∏–Ω–æ–≤
        const ALLOWED_USERS = [1271410534, 1248292955]; 

        let currTab = 'income';
        let dataCache = { income: null, expense: null };
        let config = { incomeItems: [], expenseItems: [] };
        let charts = {};

        // --- –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø ---
        window.onload = function() {
            // 1. –°–æ–æ–±—â–∞–µ–º —Ç–µ–ª–µ–≥—Ä–∞–º—É —á—Ç–æ –ø—Ä–∏–ª–æ–∂–µ–Ω–∏–µ –≥–æ—Ç–æ–≤–æ
            if (window.Telegram && window.Telegram.WebApp) {
                window.Telegram.WebApp.ready();
                window.Telegram.WebApp.expand(); // –†–∞–∑–≤–æ—Ä–∞—á–∏–≤–∞–µ–º –Ω–∞ –≤–µ—Å—å —ç–∫—Ä–∞–Ω
            }

            // 2. –ü—Ä–æ–≤–µ—Ä–∫–∞ –¥–æ—Å—Ç—É–ø–∞
            if (!checkAccess()) return;

            // 3. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö
            toggleLoader(true);
            runBackend('getInitialConfig').then(res => {
                config = res;
                // –ó–∞–ø–æ–ª–Ω—è–µ–º —Å–µ–ª–µ–∫—Ç—ã –¥–∞—Ç—ã
                const ySel = document.getElementById('anYear'), mSel = document.getElementById('anMonth');
                ySel.innerHTML=''; res.years.forEach(y => ySel.add(new Option(y, y)));
                mSel.innerHTML=''; mSel.add(new Option('–í–µ—Å—å –≥–æ–¥', 'all')); 
                res.months.forEach((m,i) => mSel.add(new Option(m, i))); 
                mSel.value = new Date().getMonth();

                refreshTable(true);
                loadAnalytics();
                toggleLoader(false);
            }).catch(e => {
                showToast("–û—à–∏–±–∫–∞ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏—è: " + e);
                toggleLoader(false);
            });
        };

        function checkAccess() {
            // –ï—Å–ª–∏ –æ—Ç–∫—Ä—ã—Ç–æ –≤ –±—Ä–∞—É–∑–µ—Ä–µ (–Ω–µ—Ç –æ–±—ä–µ–∫—Ç–∞ Telegram), —Ä–∞–∑—Ä–µ—à–∞–µ–º (–¥–ª—è —Ç–µ—Å—Ç–æ–≤)
            // –ï—Å–ª–∏ –Ω—É–∂–Ω–æ –∂–µ—Å—Ç–∫–æ –±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å –ü–ö –±—Ä–∞—É–∑–µ—Ä, —É–±–µ—Ä–∏—Ç–µ —ç—Ç–æ—Ç if
            if (!window.Telegram || !window.Telegram.WebApp || !window.Telegram.WebApp.initDataUnsafe || !window.Telegram.WebApp.initDataUnsafe.user) {
                console.warn("–ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö Telegram. –†–µ–∂–∏–º —Ç–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è (–ü–ö).");
                return true; 
            }

            const user = window.Telegram.WebApp.initDataUnsafe.user;
            if (!ALLOWED_USERS.includes(user.id)) {
                document.getElementById('accessDenied').style.display = 'flex';
                document.getElementById('userIdDisplay').innerText = `ID: ${user.id}`;
                document.querySelector('.nav').style.display = 'none';
                document.querySelector('.content-area').style.display = 'none';
                return false;
            }
            return true;
        }

        // --- –õ–û–ì–ò–ö–ê ---
        function switchTab(tab) {
            currTab = tab;
            // –ê–∫—Ç–∏–≤–Ω—ã–µ –∫–Ω–æ–ø–∫–∏
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            event.currentTarget.classList.add('active');
            
            // –ü–æ–∫–∞–∑ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
            document.querySelectorAll('.tab-page').forEach(p => p.classList.remove('active'));
            if (tab === 'analytics') {
                document.getElementById('analyticsTab').classList.add('active');
            } else {
                document.getElementById('splitTab').classList.add('active');
                updateFormTitle();
                if (!dataCache[tab]) refreshTable(true);
                else renderTable(dataCache[tab]);
            }
            window.scrollTo({top:0, behavior:'smooth'});
        }

        function updateFormTitle() {
            const isInc = currTab === 'income';
            document.getElementById('formTitle').innerText = isInc ? '–ù–æ–≤—ã–π –ú–∞—Å—Ç–µ—Ä-–∫–ª–∞—Å—Å' : '–ù–æ–≤—ã–π –†–∞—Å—Ö–æ–¥';
            document.getElementById('tableTitle').innerText = isInc ? '–ò—Å—Ç–æ—Ä–∏—è (–î–æ—Ö–æ–¥)' : '–ò—Å—Ç–æ—Ä–∏—è (–†–∞—Å—Ö–æ–¥)';
            document.getElementById('inpName').value = '';
            document.getElementById('inpPrice').value = '';
            document.getElementById('inpQty').value = 1;
            calcTotal();
        }

        function calcTotal() {
            const p = parseFloat(document.getElementById('inpPrice').value) || 0;
            const q = parseFloat(document.getElementById('inpQty').value) || 0;
            document.getElementById('txtTotal').innerText = (p * q).toLocaleString() + ' ‚ÇΩ';
        }

        function modVal(id, delta) {
            const el = document.getElementById(id);
            let val = parseFloat(el.value) || 0;
            val += delta;
            if (val < 1) val = 1;
            el.value = val;
            calcTotal();
        }

        // --- –ü–û–ò–°–ö ---
        function showSearch(e) {
            const val = e.target.value.toLowerCase();
            const box = document.getElementById('searchRes');
            box.innerHTML = '';
            if (!val) { box.style.display='none'; return; }
            
            const items = currTab === 'income' ? config.incomeItems : config.expenseItems;
            const filtered = items.filter(i => i.toLowerCase().includes(val)).slice(0, 5);
            
            if (filtered.length) {
                box.style.display = 'block';
                filtered.forEach(item => {
                    const div = document.createElement('div');
                    div.style.padding = '10px';
                    div.style.borderBottom = '1px solid var(--border)';
                    div.style.cursor = 'pointer';
                    div.innerText = item;
                    div.onclick = () => {
                        document.getElementById('inpName').value = item;
                        box.style.display = 'none';
                    };
                    box.appendChild(div);
                });
            } else {
                box.style.display = 'none';
            }
        }

        // --- BACKEND ---
        async function runBackend(action, payload = {}) {
            // –î–ª—è Google Apps Script —Å—Ä–µ–¥—ã
            if (typeof google !== 'undefined' && google.script && google.script.run) {
                return new Promise((resolve, reject) => {
                    if (action === 'getInitialConfig') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getInitialConfig();
                    else if (action === 'saveTransaction') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).saveTransaction(payload);
                    else if (action === 'getTableData') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getTableData(payload.type);
                    else if (action === 'getAnalyticsData') google.script.run.withSuccessHandler(resolve).withFailureHandler(reject).getAnalyticsData(payload.year, payload.monthIdx);
                    else reject("Unknown action");
                });
            } else {
                // –î–ª—è —Ç–µ—Å—Ç–∞ —á–µ—Ä–µ–∑ fetch (–ü–ö)
                payload.action = action;
                const res = await fetch(GAS_URL, {
                    method: 'POST',
                    body: JSON.stringify(payload)
                });
                return await res.json();
            }
        }

        function submitEntry() {
            const name = document.getElementById('inpName').value;
            const price = document.getElementById('inpPrice').value;
            const qty = document.getElementById('inpQty').value;
            
            if (!name || !price) { showToast("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –ø–æ–ª—è!"); return; }

            toggleLoader(true);
            const payload = {
                type: currTab,
                name: name,
                price: parseFloat(price),
                qty: parseFloat(qty),
                total: parseFloat(price) * parseFloat(qty),
                isNew: true // –£–ø—Ä–æ—Å—Ç–∏–ª–∏ –ª–æ–≥–∏–∫—É
            };

            runBackend('saveTransaction', payload).then(res => {
                toggleLoader(false);
                if (res.success) {
                    showToast("–£—Å–ø–µ—à–Ω–æ!");
                    refreshTable(true);
                    updateFormTitle(); // —Å–±—Ä–æ—Å –ø–æ–ª–µ–π
                } else {
                    showToast("–û—à–∏–±–∫–∞: " + res.message);
                }
            });
        }

        function refreshTable(force) {
            const tbody = document.getElementById('tableBody');
            if (force) {
                tbody.innerHTML = '';
                document.getElementById('emptyMsg').style.display = 'block';
                runBackend('getTableData', {type: currTab}).then(data => {
                    dataCache[currTab] = data;
                    renderTable(data);
                });
            } else if (dataCache[currTab]) {
                renderTable(dataCache[currTab]);
            }
        }

        function renderTable(data) {
            const tbody = document.getElementById('tableBody');
            const msg = document.getElementById('emptyMsg');
            tbody.innerHTML = '';
            
            if (!data || data.length === 0) {
                msg.style.display = 'block';
                msg.innerText = "–ù–µ—Ç –∑–∞–ø–∏—Å–µ–π";
                return;
            }
            msg.style.display = 'none';

            data.forEach(row => {
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td style="color:var(--text-sub)">${row.dateStr.slice(0,5)}</td>
                    <td style="font-weight:600">${row.name}</td>
                    <td style="font-weight:bold">${row.total}</td>
                    <td><button style="border:none; bg:none; color:var(--text-sub)">‚ãÆ</button></td>
                `;
                tbody.appendChild(tr);
            });
        }

        function loadAnalytics() {
            // –£–ø—Ä–æ—â–µ–Ω–Ω–∞—è –∑–∞–≥–ª—É—à–∫–∞ –¥–ª—è –∞–Ω–∞–ª–∏—Ç–∏–∫–∏, —á—Ç–æ–±—ã –Ω–µ –∑–∞–≥—Ä–æ–º–æ–∂–¥–∞—Ç—å –∫–æ–¥
            const y = document.getElementById('anYear').value;
            const m = document.getElementById('anMonth').value;
            // toggleLoader(true);
            runBackend('getAnalyticsData', {year: y, monthIdx: m}).then(d => {
                // toggleLoader(false);
                document.getElementById('kpiInc').innerText = d.current.income.toLocaleString();
                document.getElementById('kpiExp').innerText = d.current.expense.toLocaleString();
                document.getElementById('kpiProf').innerText = d.current.profit.toLocaleString();
                document.getElementById('kpiVis').innerText = d.current.visitors.toLocaleString();
                
                renderChart('chartPulse', d.pulse.labels, d.pulse.income, d.pulse.expense);
                renderChart('chartAttendance', d.attendance.labels, d.attendance.data, null, 'line');
                // –°–ø–∏—Å–∫–∏ —Ç–æ–ø–æ–≤ –º–æ–∂–Ω–æ –¥–æ–ø–∏—Å–∞—Ç—å –∞–Ω–∞–ª–æ–≥–∏—á–Ω–æ —Ç–∞–±–ª–∏—Ü–µ
            });
        }

        function renderChart(id, labels, d1, d2, type='line') {
            const ctx = document.getElementById(id).getContext('2d');
            if (charts[id]) charts[id].destroy();
            
            let datasets = [{
                label: 'Data 1', data: d1, borderColor: '#34C759', backgroundColor: 'rgba(52, 199, 89, 0.1)', fill: true, tension: 0.4
            }];
            if (d2) {
                datasets.push({
                    label: 'Data 2', data: d2, borderColor: '#FF3B30', backgroundColor: 'rgba(255, 59, 48, 0.1)', fill: true, tension: 0.4
                });
            }

            charts[id] = new Chart(ctx, {
                type: type,
                data: { labels: labels, datasets: datasets },
                options: { responsive: true, plugins: { legend: {display: false} }, scales: { x: {display:false}, y: {display:false} } }
            });
        }

        function toggleTheme() {
            const body = document.body;
            const curr = body.getAttribute('data-theme');
            const next = curr === 'light' ? 'dark' : 'light';
            body.setAttribute('data-theme', next);
            localStorage.setItem('theme', next);
        }

        function toggleLoader(show) {
            document.getElementById('loader').style.display = show ? 'block' : 'none';
        }
        function showToast(msg) {
            const t = document.getElementById('toast');
            t.innerText = msg;
            t.classList.add('show');
            setTimeout(() => t.classList.remove('show'), 3000);
        }

        // –ü—Ä–∏–º–µ–Ω–∏—Ç—å —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω—É—é —Ç–µ–º—É
        if (localStorage.getItem('theme') === 'dark') document.body.setAttribute('data-theme', 'dark');
    </script>
</body>
</html>
